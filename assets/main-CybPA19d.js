import{g as T,r as l}from"./math-BLsufJHS.js";import{V as w}from"./Particle-CCsMxs2b.js";import{F as E}from"./Firework-Dr4BiqZG.js";import{T as g,A as x,F as b,B as C}from"./BeatDetector-CNMq8YQG.js";class k{canvas;ctx;dpr=1;width=0;height=0;constructor(t){this.canvas=t;const e=t.getContext("2d");if(!e)throw new Error("Failed to get 2D context");this.ctx=e,this.resize(),window.addEventListener("resize",()=>this.resize())}get context(){return this.ctx}resize(){this.dpr=window.devicePixelRatio||1,this.width=window.innerWidth,this.height=window.innerHeight,this.canvas.width=Math.floor(this.width*this.dpr),this.canvas.height=Math.floor(this.height*this.dpr),this.canvas.style.width=`${this.width}px`,this.canvas.style.height=`${this.height}px`,this.ctx.scale(this.dpr,this.dpr)}drawBackground(){this.ctx.globalAlpha=1,this.ctx.globalCompositeOperation="source-over";const t=this.ctx.createLinearGradient(0,0,0,this.height);t.addColorStop(0,w.SKY_GRADIENT_TOP),t.addColorStop(1,w.SKY_GRADIENT_BOTTOM),this.ctx.fillStyle=t,this.ctx.fillRect(0,0,this.width,this.height),this.ctx.fillStyle="rgba(0, 5, 20, 0.2)",this.ctx.fillRect(0,0,this.width,this.height)}drawWater(){const t=this.height*(1-w.WATER_HEIGHT_RATIO);this.ctx.globalCompositeOperation="source-over";const e=this.ctx.createLinearGradient(0,t,0,this.height);e.addColorStop(0,"rgba(0, 5, 20, 0.6)"),e.addColorStop(1,"#000"),this.ctx.fillStyle=e,this.ctx.fillRect(0,t,this.width,this.height-t)}setLighterBlend(){this.ctx.globalCompositeOperation="lighter"}resetBlend(){this.ctx.globalCompositeOperation="source-over"}get horizonY(){return this.height*(1-w.WATER_HEIGHT_RATIO)}}class A{particles=[];get count(){return this.particles.length}add(t){Array.isArray(t)?this.particles.push(...t):this.particles.push(t)}update(){for(let t=this.particles.length-1;t>=0;t--){const e=this.particles[t];e.update(),e.isAlive||this.particles.splice(t,1)}}draw(t,e){for(const n of this.particles)n.draw(t,e)}clear(){this.particles=[]}getParticles(){return this.particles}}class P{fireworks=[];screenWidth;screenHeight;onParticlesCreated;constructor(t,e,n){this.screenWidth=t,this.screenHeight=e,this.onParticlesCreated=n}resize(t,e){this.screenWidth=t,this.screenHeight=e}get count(){return this.fireworks.length}launch(t,e=!1,n,i=.5,s){const r=s??T(this.screenWidth),o=n??l(this.screenHeight*.1,this.screenHeight*.4),c=l(0,360),u=new E(r,o,t,c,this.screenHeight,this.screenWidth,{onExplode:this.onParticlesCreated},i);e?u.explodeNow():this.fireworks.push(u)}launchAt(t,e,n,i,s,r=!1){const o=new E(e,n,t,s,this.screenHeight,this.screenWidth,{onExplode:this.onParticlesCreated},i);r?o.explodeNow():this.fireworks.push(o)}launchMultiple(t){for(const e of t)e.delay&&e.delay>0?setTimeout(()=>{this.launchAt(e.type,e.x,e.targetY,e.energy,e.hue,e.instant)},e.delay):this.launchAt(e.type,e.x,e.targetY,e.energy,e.hue,e.instant)}salvo(t,e=50){for(let n=0;n<t;n++)setTimeout(()=>{const i=Math.random()>.4?"willow":Math.random()>.5?"kiku":"botan",s=Math.random()>.9,r=this.screenHeight*l(.1,.5);this.launch(i,s,r,l(.3,.8))},n*e)}getScreenWidth(){return this.screenWidth}getScreenHeight(){return this.screenHeight}update(){for(let t=this.fireworks.length-1;t>=0;t--){const e=this.fireworks[t];e.update(),e.dead&&this.fireworks.splice(t,1)}}draw(t){for(const e of this.fireworks)e.draw(t)}clear(){this.fireworks=[]}}class B{events=[];currentIndex=0;startTime=0;audioContext=null;source=null;callbacks;lastSalvoTime=g.timeline.initialSalvoTime;isPlaying=!1;isPaused=!1;constructor(t){this.callbacks=t}loadEvents(t){this.events=[...t],this.currentIndex=0,this.lastSalvoTime=g.timeline.initialSalvoTime}async play(t){if(this.audioContext||(this.audioContext=new AudioContext),this.audioContext.state==="suspended"&&await this.audioContext.resume(),this.source)try{this.source.stop()}catch{}this.source=this.audioContext.createBufferSource(),this.source.buffer=t,this.source.connect(this.audioContext.destination),this.source.start(0),this.startTime=this.audioContext.currentTime,this.currentIndex=0,this.isPlaying=!0,this.isPaused=!1,this.source.onended=()=>{this.isPlaying=!1}}async pause(){this.audioContext&&this.audioContext.state==="running"&&(await this.audioContext.suspend(),this.isPaused=!0)}async resume(){this.audioContext&&this.audioContext.state==="suspended"&&(await this.audioContext.resume(),this.isPaused=!1)}stop(){if(this.source){try{this.source.stop()}catch{}this.source=null}this.isPlaying=!1,this.isPaused=!1,this.currentIndex=0}async close(){if(this.stop(),this.audioContext){try{await this.audioContext.close()}catch{}this.audioContext=null}}get currentTime(){return!this.audioContext||!this.isPlaying?0:this.audioContext.currentTime-this.startTime}update(){if(!this.isPlaying||this.isPaused)return;const t=this.currentTime;for(this.callbacks.onTick?.(t);this.currentIndex<this.events.length&&this.events[this.currentIndex].launchTime<=t;){const e=this.events[this.currentIndex];this.fireEvent(e,t),this.currentIndex++}}fireEvent(t,e){switch(t.type){case"bass":t.isClimax&&e-this.lastSalvoTime>g.timeline.climaxCooldown?(this.callbacks.onClimax?.(t),this.lastSalvoTime=e):this.callbacks.onBass?.(t);break;case"mid":this.callbacks.onMid?.(t);break;case"piano":this.callbacks.onPiano?.(t);break}}getEvents(){return this.events}static eventToFireworkType(t,e){switch(t){case"bass":return e||Math.random()>g.timeline.climaxWillowRoll?"willow":"kiku";case"mid":return"botan";case"piano":return"botan";default:return"kiku"}}}class I{execute(t,e){const n=t.getScreenWidth(),i=t.getScreenHeight(),s=e.x??l(n*.2,n*.8),r=e.targetY??i*l(.15,.35),o=e.energy??.5,c=e.hue??l(0,360),u=e.type??"botan";t.launchAt(u,s,r,o,c)}}class D{execute(t,e){const n=t.getScreenWidth(),i=t.getScreenHeight(),s=e.count??15,r=e.interval??50,o=e.spread??.6;for(let c=0;c<s;c++)setTimeout(()=>{const u=l(n*(.5-o/2),n*(.5+o/2)),a=i*l(.1,.4),h=l(.4,.8),d=e.hue??l(0,360),p=Math.random()>.5?"willow":"kiku",f=Math.random()>.9;t.launchAt(p,u,a,h,d,f)},c*r)}}class M{execute(t,e){const n=t.getScreenWidth(),i=t.getScreenHeight(),s=e.count??8,r=e.direction??"left",c=(e.duration??1e3)/s;for(let u=0;u<s;u++)setTimeout(()=>{let a;const h=u/(s-1);switch(r){case"left":a=n*(.1+h*.8);break;case"right":a=n*(.9-h*.8);break;case"center":a=n*(.5+(h-.5)*.6);break;case"outward":a=u%2===0?n*(.5-h*.4):n*(.5+h*.4);break;default:a=n*(.1+h*.8)}const d=i*l(.15,.35),p=e.energy??.5,f=(e.hue??0)+u*15,y=e.type??"kiku";t.launchAt(y,a,d,p,f%360)},u*c)}}class Y{execute(t,e){const n=t.getScreenWidth(),i=t.getScreenHeight(),s=e.count??2,r=e.spread??.3,o=n/2;for(let c=0;c<s;c++){const u=(c+1)*r*n/(s+1),a=i*l(.15,.35),h=e.energy??.6,d=e.hue??l(0,360),p=e.type??"kiku";t.launchAt(p,o-u,a,h,d),t.launchAt(p,o+u,a,h,d)}}}class W{execute(t,e){const n=t.getScreenWidth(),i=t.getScreenHeight(),s=e.count??5,r=e.interval??200,o=i*.4,c=i*.1;for(let u=0;u<s;u++)setTimeout(()=>{const a=u/(s-1),h=n*(.3+a*.4),d=o-a*(o-c),p=.4+a*.4,f=(e.hue??30)+u*20,y=e.type??"botan";t.launchAt(y,h,d,p,f%360)},u*r)}}class H{execute(t,e){const n=t.getScreenWidth(),i=t.getScreenHeight(),s=e.count??4,r=e.interval??500;for(let o=0;o<s;o++)setTimeout(()=>{const c=o%4===0,u=l(n*.2,n*.8),a=i*(c?.15:.25),h=c?.8:.5,d=e.hue??l(0,360),p=c?"kiku":"botan";t.launchAt(p,u,a,h,d)},o*r)}}class R{execute(t,e){const n=t.getScreenWidth(),i=t.getScreenHeight(),s=e.count??4,r=e.x??n*l(.3,.7),o=e.targetY??i*l(.15,.3),c=e.hue??l(0,360),u=["kiku","botan","willow"];for(let a=0;a<s;a++)setTimeout(()=>{const h=l(-30,30),d=l(-20,20),p=(c+a*30)%360,f=u[a%u.length],y=l(.5,.8);t.launchAt(f,r+h,o+d,y,p)},a*30)}}class F{execute(t,e){const n=t.getScreenWidth(),i=t.getScreenHeight(),s=e.count??3,r=e.interval??150,o=i*.25;for(let c=0;c<s;c++)setTimeout(()=>{const u=(c+1)*.15,a=(e.hue??0)+c*40,h=e.type??"kiku",d=e.energy??.6;t.launchAt(h,n*u,o,d,a),t.launchAt(h,n*(1-u),o,d,(a+180)%360)},c*r)}}class L{execute(t,e){const n=t.getScreenWidth(),i=t.getScreenHeight(),s=e.count??5,r=e.duration??2e3,o=e.energy??.4;for(let c=0;c<s;c++)setTimeout(()=>{const u=l(n*.1,n*.9),a=i*l(.2,.5),h=Math.max(.35,o*l(.8,1.2)),d=e.hue??l(30,60);t.launchAt("piano",u,a,h,d)},l(0,r))}}class z{execute(t,e){const n=t.getScreenWidth(),i=t.getScreenHeight(),s=e.energy??1,r=Math.floor(30*s);for(let o=0;o<r/3;o++)setTimeout(()=>{const c=l(n*.1,n*.9),u=i*l(.15,.4),a=l(.5,.8),h=l(0,360),d=Math.random()>.5?"kiku":"botan";t.launchAt(d,c,u,a,h)},l(0,1e3));for(let o=0;o<r/2;o++)setTimeout(()=>{const c=l(n*.05,n*.95),u=i*l(.1,.35),a=l(.7,1),h=l(0,360),d=Math.random()>.3?"willow":"kiku",p=Math.random()>.7;t.launchAt(d,c,u,a,h,p)},1e3+l(0,1e3));for(let o=0;o<r/6;o++)setTimeout(()=>{const c=l(.1,.4)*n,u=i*l(.1,.25),a=.9,h=l(0,60);t.launchAt("willow",n/2-c,u,a,h),t.launchAt("willow",n/2+c,u,a,h)},2e3+o*100)}}class _{patterns=new Map;constructor(){this.registerBuiltinPatterns()}registerBuiltinPatterns(){this.patterns.set("single",new I),this.patterns.set("salvo",new D),this.patterns.set("cascade",new M),this.patterns.set("symmetric",new Y),this.patterns.set("rising",new W),this.patterns.set("pulse",new H),this.patterns.set("cluster",new R),this.patterns.set("cross",new F),this.patterns.set("scatter",new L),this.patterns.set("finale",new z)}get(t){const e=this.patterns.get(t);if(!e)throw new Error(`Unknown pattern type: ${t}`);return e}execute(t,e,n){this.get(t).execute(e,n)}has(t){return this.patterns.has(t)}}class v{windowSize;minSectionDuration;constructor(t=g.sectionDetector.windowSize,e=g.sectionDetector.minSectionDuration){this.windowSize=t,this.minSectionDuration=e}detect(t,e){if(t.length===0||e<=0)return[this.createSection("verse",0,e,g.sectionDetector.defaultEnergy,0)];const n=this.createWindows(t,e);this.calculateTrends(n);const i=this.classifyWindows(n,e),s=this.mergeSections(i);return this.applyMinDuration(s,e)}createWindows(t,e){const n=[],i=Math.ceil(e/this.windowSize);for(let s=0;s<i;s++){const r=s*this.windowSize,o=Math.min((s+1)*this.windowSize,e),c=t.filter(h=>h.explodeTime>=r&&h.explodeTime<o),u=c.length>0?c.reduce((h,d)=>h+d.energy,0)/c.length:0,a=c.filter(h=>h.isClimax).length;n.push({startTime:r,endTime:o,avgEnergy:u,eventCount:c.length,climaxCount:a,trend:"stable"})}return n}calculateTrends(t){const e=g.sectionDetector.trendThreshold;for(let n=1;n<t.length;n++){const i=t[n-1],s=t[n],r=s.avgEnergy-i.avgEnergy;r>e?s.trend="rising":r<-e?s.trend="falling":s.trend="stable"}}classifyWindows(t,e){const n=[],i=g.sectionDetector,s=t.map(a=>a.avgEnergy).filter(a=>a>0),r=s.length>0?s.reduce((a,h)=>a+h,0)/s.length:i.defaultEnergy,o=Math.max(...s,i.defaultEnergy),c=r+(o-r)*i.highThresholdFactor,u=r*i.lowThresholdFactor;for(const a of t){let h;const{avgEnergy:d,climaxCount:p,trend:f,eventCount:y}=a;p>i.climaxCountThreshold||d>c*i.climaxEnergyFactor?h="climax":d>c*i.chorusEnergyFactor&&y>i.chorusEventCount?h="chorus":f==="rising"&&d>r*i.prechorusEnergyFactor?h="prechorus":d<u||y<i.lowEventCount?a.startTime<e*i.introPosition?h="intro":a.endTime>e*i.outroPosition?h="outro":h="bridge":h="verse",n.push(this.createSection(h,a.startTime,a.endTime,d,y/this.windowSize))}return n}mergeSections(t){if(t.length===0)return[];const e=[];let n={...t[0]};for(let i=1;i<t.length;i++){const s=t[i];s.type===n.type?(n.endTime=s.endTime,n.energy=(n.energy+s.energy)/2,n.density=(n.density+s.density)/2):(e.push(n),n={...s})}return e.push(n),e}applyMinDuration(t,e){const n=[];for(const i of t)if(i.endTime-i.startTime<this.minSectionDuration&&n.length>0){const r=n[n.length-1];r.endTime=i.endTime,r.energy=(r.energy+i.energy)/2,r.density=(r.density+i.density)/2}else n.push(i);return n.length===0&&n.push(this.createSection("verse",0,e,g.sectionDetector.defaultEnergy,0)),n}createSection(t,e,n,i,s){return{type:t,startTime:e,endTime:n,energy:i,density:s}}static getSectionAt(t,e){for(const n of t)if(e>=n.startTime&&e<n.endTime)return n;return null}static isNearTransition(t,e,n=g.sectionDetector.transitionThreshold){for(const i of t)if(Math.abs(e-i.startTime)<n)return!0;return!1}}class O{rules=[];ruleStates=new Map;constructor(){this.registerDefaultRules()}registerDefaultRules(){const t=g.ruleEngine;this.addRule({id:"finale",priority:100,cooldown:t.finale.cooldown,exclusive:!0,condition:e=>e.duration-e.currentTime<t.finale.remainingSeconds&&e.currentEvent.energy>t.finale.minEnergy,action:e=>({pattern:"finale",launchTime:e.currentTime,params:{duration:0,targetY:e.screenHeight*t.finale.targetY,energy:e.currentEvent.energy}})}),this.addRule({id:"climax_salvo",priority:90,cooldown:t.climaxSalvo.cooldown,exclusive:!0,condition:e=>e.currentSection?.type==="climax"&&e.currentEvent.isClimax&&e.currentEvent.type==="bass",action:e=>({pattern:"salvo",launchTime:e.currentTime,params:{duration:0,targetY:e.screenHeight*t.climaxSalvo.targetY,count:Math.floor(t.climaxSalvo.countBase+e.currentEvent.energy*t.climaxSalvo.countEnergyScale),interval:t.climaxSalvo.intervalMs,energy:e.currentEvent.energy}})}),this.addRule({id:"beat_drop",priority:85,cooldown:t.beatDrop.cooldown,exclusive:!0,condition:e=>{const n=t.beatDrop.recentEnergyWindow;return!e.beatInfo||e.recentEvents.length<n||!e.beatInfo.beats.some(r=>Math.abs(r-e.currentTime)<t.beatDrop.nearBeatTolerance)?!1:e.recentEvents.slice(-n).reduce((r,o)=>r+o.energy,0)/n<t.beatDrop.recentEnergyThreshold&&e.currentEvent.energy>t.beatDrop.minEnergy},action:e=>({pattern:"cluster",launchTime:e.currentTime,params:{duration:0,targetY:e.screenHeight*t.beatDrop.targetY,count:t.beatDrop.count,energy:e.currentEvent.energy,x:e.screenWidth/2}})}),this.addRule({id:"section_transition",priority:80,cooldown:t.sectionTransition.cooldown,exclusive:!1,condition:e=>e.currentSection?e.currentTime-e.currentSection.startTime<t.sectionTransition.nearStartWindow:!1,action:e=>({pattern:{intro:"scatter",verse:"single",prechorus:"rising",chorus:"symmetric",bridge:"cross",climax:"salvo",outro:"scatter"}[e.currentSection.type]||"single",launchTime:e.currentTime,params:{duration:0,targetY:e.screenHeight*t.sectionTransition.targetY,energy:e.currentEvent.energy}})}),this.addRule({id:"chorus_symmetric",priority:70,cooldown:t.chorusSymmetric.cooldown,exclusive:!1,condition:e=>e.currentSection?.type==="chorus"&&e.currentEvent.type==="bass"&&e.currentEvent.energy>t.chorusSymmetric.minEnergy,action:e=>({pattern:"symmetric",launchTime:e.currentTime,params:{duration:0,targetY:e.currentEvent.targetY,count:2,spread:t.chorusSymmetric.spread,energy:e.currentEvent.energy}})}),this.addRule({id:"piano_beat_sync",priority:60,cooldown:t.pianoBeatSync.cooldown,exclusive:!1,condition:e=>{if(e.currentEvent.type!=="piano"||!e.beatInfo)return!1;const n=e.beatInfo.beats.reduce((i,s)=>Math.abs(s-e.currentEvent.explodeTime)<Math.abs(i-e.currentEvent.explodeTime)?s:i,e.beatInfo.beats[0]??0);return Math.abs(n-e.currentEvent.explodeTime)<t.pianoBeatSync.beatTolerance},action:e=>({pattern:"single",launchTime:e.currentTime,params:{duration:0,targetY:e.currentEvent.targetY,energy:Math.max(t.pianoBeatSync.minEnergy,e.currentEvent.energy*t.pianoBeatSync.energyScale),type:"piano",hue:t.pianoBeatSync.hue}})}),this.addRule({id:"bass_impact",priority:50,cooldown:t.bassImpact.cooldown,exclusive:!1,condition:e=>e.currentEvent.type==="bass"&&e.currentEvent.energy>t.bassImpact.minEnergy,action:e=>({pattern:"single",launchTime:e.currentTime,params:{duration:0,targetY:e.currentEvent.targetY,energy:e.currentEvent.energy,type:e.currentEvent.isClimax?"willow":"kiku"}})}),this.addRule({id:"mid_accent",priority:40,cooldown:t.midAccent.cooldown,exclusive:!1,condition:e=>e.currentEvent.type==="mid"&&e.currentEvent.energy>t.midAccent.minEnergy,action:e=>({pattern:"single",launchTime:e.currentTime,params:{duration:0,targetY:e.currentEvent.targetY,energy:e.currentEvent.energy*t.midAccent.energyScale,type:"botan"}})}),this.addRule({id:"ambient_scatter",priority:20,cooldown:t.ambientScatter.cooldown,exclusive:!1,condition:e=>e.currentEvent.type==="piano"&&e.currentSection?.type!=="climax"&&e.currentEvent.energy<t.ambientScatter.maxEnergy,action:e=>({pattern:"scatter",launchTime:e.currentTime,params:{duration:0,targetY:e.screenHeight*t.ambientScatter.targetY,count:t.ambientScatter.count,energy:t.ambientScatter.energy}})}),this.rules.sort((e,n)=>n.priority-e.priority)}addRule(t){this.rules.push(t),this.rules.sort((e,n)=>n.priority-e.priority),this.ruleStates.set(t.id,{lastFired:-1/0})}evaluate(t){const e=[];for(const n of this.rules){const i=this.ruleStates.get(n.id)??{lastFired:-1/0};if(t.currentTime-i.lastFired<n.cooldown||!n.condition(t))continue;const s=n.action(t);if(s&&(e.push(s),i.lastFired=t.currentTime,this.ruleStates.set(n.id,i),n.exclusive))break}return e}reset(){for(const[t]of this.ruleStates)this.ruleStates.set(t,{lastFired:-1/0})}getRule(t){return this.rules.find(e=>e.id===t)}setRuleCooldown(t,e){const n=this.getRule(t);n&&(n.cooldown=e)}}const S=(...m)=>{};class N{patternLibrary;sectionDetector;ruleEngine;launcher=null;sections=[];events=[];beatInfo=null;duration=0;scheduledCommands=[];currentEventIndex=0;recentEvents=[];recentEventsWindow=g.choreographer.recentEventsWindow;recentLaunches=[];launchTrackingWindow=g.choreographer.launchTrackingWindow;minEnergyFloor=g.choreographer.minEnergyFloor;sparseThreshold=g.choreographer.sparseThreshold;constructor(){this.patternLibrary=new _,this.sectionDetector=new v,this.ruleEngine=new O}setLauncher(t){this.launcher=t}prepareTrack(t){this.events=[...t.events].sort((e,n)=>e.explodeTime-n.explodeTime),this.beatInfo=t.beatInfo,this.duration=t.duration,this.sections=this.sectionDetector.detect(this.events,this.duration),this.reset(),S("[Choreographer] Track prepared:",{events:this.events.length,sections:this.sections.length,bpm:this.beatInfo.bpm,duration:this.duration}),S("[Choreographer] Detected sections:",this.sections)}reset(){this.currentEventIndex=0,this.recentEvents=[],this.scheduledCommands=[],this.recentLaunches=[],this.ruleEngine.reset()}update(t){if(!(!this.launcher||this.events.length===0)){for(;this.currentEventIndex<this.events.length&&this.events[this.currentEventIndex].explodeTime<=t+g.choreographer.lookAheadSeconds;){const e=this.events[this.currentEventIndex];this.processEvent(e,t),this.currentEventIndex++}this.executeScheduledCommands(t),this.recentEvents=this.recentEvents.filter(e=>t-e.explodeTime<this.recentEventsWindow)}}processEvent(t,e){if(!this.launcher)return;this.recentEvents.push(t);const n={currentTime:e,currentEvent:t,currentSection:v.getSectionAt(this.sections,e),beatInfo:this.beatInfo,duration:this.duration,screenWidth:this.launcher.getScreenWidth(),screenHeight:this.launcher.getScreenHeight(),recentEvents:[...this.recentEvents]},i=this.ruleEngine.evaluate(n);for(const s of i)this.scheduleCommand(s)}scheduleCommand(t){this.scheduledCommands.push({command:t,executed:!1})}executeScheduledCommands(t){if(this.launcher){for(const e of this.scheduledCommands)e.executed||t>=e.command.launchTime&&(this.executeCommand(e.command),e.executed=!0);this.scheduledCommands=this.scheduledCommands.filter(e=>!e.executed)}}executeCommand(t){if(!this.launcher)return;const e=t.launchTime;this.recentLaunches=this.recentLaunches.filter(r=>e-r<this.launchTrackingWindow);const n=this.recentLaunches.length,i=n<=this.sparseThreshold,s={...t.params};if(i&&s.energy!==void 0){const r=1+(this.sparseThreshold-n)*g.choreographer.sparseBoostPerMissing,o=Math.max(this.minEnergyFloor,s.energy*r);s.energy=Math.min(g.choreographer.energyCap,o)}else i&&s.energy===void 0&&(s.energy=this.minEnergyFloor);this.recentLaunches.push(e);try{this.patternLibrary.execute(t.pattern,this.launcher,s)}catch(r){console.warn("[Choreographer] Failed to execute pattern:",t.pattern,r)}}getCurrentSection(t){return v.getSectionAt(this.sections,t)}getSections(){return[...this.sections]}getBeatInfo(){return this.beatInfo}isNearTransition(t,e=g.sectionDetector.transitionThreshold){return v.isNearTransition(this.sections,t,e)}triggerPattern(t,e={}){if(!this.launcher)return;const n={duration:0,targetY:this.launcher.getScreenHeight()*g.choreographer.defaultTrigger.targetYFactor,energy:g.choreographer.defaultTrigger.energy};this.patternLibrary.execute(t,this.launcher,{...n,...e})}getStats(){const t={};for(const e of this.sections)t[e.type]=(t[e.type]||0)+1;return{totalEvents:this.events.length,totalSections:this.sections.length,sectionBreakdown:t,bpm:this.beatInfo?.bpm??0,duration:this.duration}}}class U{renderer;particleSystem;launcher;audioAnalyzer;frequencyAnalyzer;beatDetector;choreographer;timeline;mode="idle";isPaused=!1;demoTimer=0;audioBuffer=null;constructor(){const t=document.getElementById("canvas");if(!t)throw new Error("Canvas not found");this.renderer=new k(t),this.particleSystem=new A,this.launcher=new P(this.renderer.width,this.renderer.height,e=>this.particleSystem.add(e)),this.audioAnalyzer=new x(this.renderer.height),this.frequencyAnalyzer=new b,this.beatDetector=new C,this.choreographer=new N,this.choreographer.setLauncher(this.launcher),this.timeline=new B({onTick:e=>this.choreographer.update(e)}),this.setupEventListeners(),this.setupResize(),this.loop()}setupEventListeners(){const t=document.getElementById("demoBtn"),e=document.getElementById("pauseBtn"),n=document.getElementById("audioInput");t?.addEventListener("click",()=>this.startDemo()),e?.addEventListener("click",()=>this.togglePause()),n?.addEventListener("change",i=>this.handleAudioUpload(i))}setupResize(){window.addEventListener("resize",()=>{this.launcher.resize(this.renderer.width,this.renderer.height),this.audioAnalyzer.resize(this.renderer.height)})}startDemo(){this.mode="demo",this.demoTimer=0,this.timeline.close(),this.setStatus("模式: 演示 (自动编排)")}togglePause(){if(this.mode==="idle")return;const t=document.getElementById("pauseBtn");this.isPaused?(this.isPaused=!1,t&&(t.textContent="暂停"),this.timeline.resume()):(this.isPaused=!0,t&&(t.textContent="继续"),this.timeline.pause())}async handleAudioUpload(t){const e=t.target,n=e.files?.[0];if(n){this.mode="music",this.isPaused=!1,this.setStatus("加载音频中...");try{await this.validateAudioFile(n),await this.timeline.close();const i=await n.arrayBuffer(),s=new AudioContext;try{this.audioBuffer=await s.decodeAudioData(i)}finally{await s.close()}const r=this.audioBuffer.duration;this.setStatus("分析音频事件... (1/3)");const o=await this.audioAnalyzer.analyze(this.audioBuffer,{onProgress:h=>{this.setStatus(`分析事件: ${Math.round(h*100)}%`)}});this.setStatus("分析频率特征... (2/3)");const c=await this.frequencyAnalyzer.analyze(this.audioBuffer);this.setStatus("检测节拍... (3/3)");const u=this.beatDetector.detectBeats(c.bass,r);this.setStatus("准备编排..."),this.choreographer.prepareTrack({events:o.timeline,beatInfo:u,freqBands:c,duration:r}),this.timeline.loadEvents(o.timeline);const a=this.choreographer.getStats();S("[HanabiApp] Choreography ready:",a),this.setStatus(`正在播放: ${n.name} | BPM: ${Math.round(a.bpm)}`),await this.timeline.play(this.audioBuffer)}catch(i){console.error("Audio loading failed:",i),this.setStatus(i instanceof Error?i.message:"音频加载失败"),this.mode="idle",this.audioBuffer=null}finally{e.value=""}}}runDemoLogic(){this.demoTimer++;const t=g.demo;let e=t.thresholdBase;if(this.demoTimer>t.midPhaseStart&&(e=t.thresholdMid),this.demoTimer>t.latePhaseStart&&(e=t.thresholdLate),Math.random()>e){const n=this.demoTimer>t.latePhaseStart?Math.random()>t.latePhaseWillowChance?"willow":"kiku":this.demoTimer>t.midPhaseStart?"kiku":"botan";this.launcher.launch(n)}this.demoTimer>t.resetAfter&&(this.demoTimer=0)}getFileExtension(t){const e=t.name.split(".");return e.length<2?null:e[e.length-1].toLowerCase()}async getAudioDuration(t){return new Promise((e,n)=>{const i=URL.createObjectURL(t),s=new Audio,r=()=>{URL.revokeObjectURL(i),s.src=""};s.preload="metadata",s.onloadedmetadata=()=>{const o=s.duration;r(),e(o)},s.onerror=()=>{r(),n(new Error("音频元数据读取失败"))},s.src=i})}async validateAudioFile(t){const e=g.audioUpload,n=this.getFileExtension(t),i=e.allowedMimeTypes.some(o=>o===t.type),s=n!==null&&e.allowedExtensions.some(o=>o===n);if(!i&&!s)throw new Error("不支持的音频格式，请使用 mp3/wav/ogg");if(t.size>e.maxFileBytes){const o=Math.round(e.maxFileBytes/1048576);throw new Error(`音频文件过大（最大 ${o}MB）`)}const r=await this.getAudioDuration(t);if(!Number.isFinite(r)||r<=0)throw new Error("无法读取音频时长");if(r>e.maxDurationSeconds){const o=Math.round(e.maxDurationSeconds/60);throw new Error(`音频时长过长（最大 ${o} 分钟）`)}}setStatus(t){const e=document.getElementById("status");e&&(e.textContent=t)}loop=()=>{requestAnimationFrame(this.loop),!this.isPaused&&(this.renderer.drawBackground(),this.mode==="music"?this.timeline.update():this.mode==="demo"&&this.runDemoLogic(),this.renderer.setLighterBlend(),this.launcher.update(),this.launcher.draw(this.renderer.context),this.particleSystem.update(),this.particleSystem.draw(this.renderer.context,this.renderer.height),this.renderer.drawWater())}}new U;
