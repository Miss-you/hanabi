var D=Object.defineProperty;var P=(T,t,o)=>t in T?D(T,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):T[t]=o;var F=(T,t,o)=>P(T,typeof t!="symbol"?t+"":t,o);import{c as B,r as b}from"./math-CmfUW7_Q.js";const E={audioUpload:{maxFileBytes:30*1024*1024,maxDurationSeconds:600,allowedMimeTypes:["audio/mpeg","audio/mp3","audio/wav","audio/x-wav","audio/ogg"],allowedExtensions:["mp3","wav","ogg"]},demo:{thresholdBase:.98,thresholdMid:.95,thresholdLate:.85,midPhaseStart:300,latePhaseStart:900,resetAfter:1300,latePhaseWillowChance:.5},audioAnalyzer:{analysisFps:60,climaxRmsThreshold:.3,climaxFramesThreshold:60,bass:{threshold:.4,thresholdClimax:.3,cooldown:.35,cooldownClimax:.2,launchRatioMin:.15,launchRatioMax:.3},mid:{threshold:.15,cooldown:.15,launchRatioMin:.4,launchRatioMax:.6},piano:{quietMin:.05,quietMax:.15,cooldown:.8,energyScale:.8,launchRatioMin:.3,launchRatioMax:.7},waveformSamples:1e3,progressStep:100},beatDetector:{fps:60,onsetWindowSeconds:.1,onsetThreshold:.15,onsetMinEnergy:.1,onsetMinDistance:.15,tempo:{fallbackBpm:120,minInterval:.3,maxInterval:1,histogramBin:.02,normalizeMinBpm:80,normalizeMaxBpm:160,confidenceDivisor:.5},beatGrid:{offsetStep:.01,alignmentTolerance:.05}},sectionDetector:{windowSize:4,minSectionDuration:8,trendThreshold:.1,highThresholdFactor:.5,lowThresholdFactor:.5,climaxCountThreshold:2,climaxEnergyFactor:.95,chorusEnergyFactor:.7,chorusEventCount:5,prechorusEnergyFactor:.8,lowEventCount:2,introPosition:.15,outroPosition:.85,defaultEnergy:.5,transitionThreshold:.5},ruleEngine:{finale:{cooldown:10,remainingSeconds:10,minEnergy:.6,targetY:.2},climaxSalvo:{cooldown:2,targetY:.2,countBase:15,countEnergyScale:10,intervalMs:40},beatDrop:{cooldown:4,nearBeatTolerance:.1,recentEnergyWindow:3,recentEnergyThreshold:.3,minEnergy:.6,targetY:.2,count:5},sectionTransition:{cooldown:8,nearStartWindow:.5,targetY:.25},chorusSymmetric:{cooldown:1.5,minEnergy:.5,spread:.25},pianoBeatSync:{cooldown:.3,beatTolerance:.05,minEnergy:.5,energyScale:.9,hue:45},bassImpact:{cooldown:.35,minEnergy:.4},midAccent:{cooldown:.2,minEnergy:.3,energyScale:.8},ambientScatter:{cooldown:3,maxEnergy:.3,targetY:.4,count:3,energy:.45}},choreographer:{recentEventsWindow:2,lookAheadSeconds:.5,launchTrackingWindow:3,sparseThreshold:3,minEnergyFloor:.55,sparseBoostPerMissing:.15,energyCap:1,defaultTrigger:{targetYFactor:.25,energy:.6}},timeline:{climaxCooldown:2,initialSalvoTime:-10,climaxWillowRoll:.6}};class q{constructor(t){F(this,"screenHeight");this.screenHeight=t}resize(t){this.screenHeight=t}async analyze(t,o){var S;const e=E.audioAnalyzer,n=t.getChannelData(0),i=t.sampleRate,s=Math.floor(i/e.analysisFps),r=[];let a=0,l=0,d=0;const m=Math.ceil(n.length/s);let c=0;for(let u=0;u<n.length;u+=s){let f=0;for(let M=0;M<s&&u+M<n.length;M++)f+=n[u+M]*n[u+M];const w=Math.sqrt(f/s),h=u/i;w>e.climaxRmsThreshold?a++:a=Math.max(0,a-1);const v=a>e.climaxFramesThreshold,z=v?e.bass.thresholdClimax:e.bass.threshold,R=v?e.bass.cooldownClimax:e.bass.cooldown,C=e.mid.threshold,A=w<e.piano.quietMax&&w>e.piano.quietMin;if(w>z&&h-l>R){const M=B(this.screenHeight,b(e.bass.launchRatioMin,e.bass.launchRatioMax));r.push({launchTime:h-M.duration,explodeTime:h,type:"bass",isClimax:v,targetY:M.targetY,energy:w}),l=h}else if(w>C&&h-d>e.mid.cooldown){const M=B(this.screenHeight,b(e.mid.launchRatioMin,e.mid.launchRatioMax));r.push({launchTime:h-M.duration,explodeTime:h,type:"mid",isClimax:v,targetY:M.targetY,energy:w}),d=h}else if(A&&h-d>e.piano.cooldown){const M=B(this.screenHeight,b(e.piano.launchRatioMin,e.piano.launchRatioMax));r.push({launchTime:h-M.duration,explodeTime:h,type:"piano",isClimax:!1,targetY:M.targetY,energy:w*e.piano.energyScale}),d=h}c++,c%e.progressStep===0&&(o!=null&&o.onProgress)&&o.onProgress(c/m)}r.sort((u,f)=>u.launchTime-f.launchTime);const p=e.waveformSamples,g=Math.floor(n.length/p),y=new Float32Array(p);for(let u=0;u<p;u++){let f=0;const w=u*g;for(let h=0;h<g&&w+h<n.length;h++)f=Math.max(f,Math.abs(n[w+h]));y[u]=f}const x={timeline:r,duration:t.duration,waveform:y,sampleRate:i};return(S=o==null?void 0:o.onComplete)==null||S.call(o,x),x}static exportJSON(t){return JSON.stringify({duration:t.duration,sampleRate:t.sampleRate,eventCount:t.timeline.length,events:t.timeline.map(o=>({type:o.type,time:o.explodeTime.toFixed(3),energy:o.energy.toFixed(3),isClimax:o.isClimax}))},null,2)}}class W{constructor(t=2048,o=30){F(this,"fftSize");F(this,"fps");this.fftSize=t,this.fps=o}async analyze(t,o){const e=t.sampleRate,n=t.getChannelData(0),i=t.duration,s=Math.floor(e/this.fps),r=Math.ceil(n.length/s),a=new Float32Array(r),l=new Float32Array(r),d=new Float32Array(r),m=[],c=e/this.fftSize,p=Math.floor(200/c),g=Math.floor(2e3/c),y=Math.floor(8e3/c),x=100;for(let S=0;S<r;S+=x){const u=Math.min(S+x,r);for(let f=S;f<u;f++){const w=f*s,h=this.computeFFT(n,w,e),v=this.downsampleSpectrum(h,128);m.push(v),a[f]=this.calculateBandEnergy(h,0,p),l[f]=this.calculateBandEnergy(h,p,g),d[f]=this.calculateBandEnergy(h,g,y)}o!=null&&o.onProgress&&o.onProgress(u/r),await this.yieldToUI()}return this.normalizeArray(a),this.normalizeArray(l),this.normalizeArray(d),{bass:a,mid:l,high:d,spectrogram:m,frequencyBinCount:128,sampleRate:e,duration:i,fps:this.fps}}computeFFT(t,o,e){const n=this.fftSize,i=new Float32Array(n/2),s=new Float32Array(n),r=new Float32Array(n);for(let a=0;a<n&&o+a<t.length;a++){const l=.5*(1-Math.cos(2*Math.PI*a/(n-1)));s[a]=(t[o+a]??0)*l}this.fft(s,r);for(let a=0;a<n/2;a++)i[a]=Math.sqrt(s[a]*s[a]+r[a]*r[a])/n;return i}fft(t,o){const e=t.length,n=Math.log2(e);if(Math.pow(2,n)!==e)throw new Error("FFT size must be a power of 2");for(let i=0;i<e;i++){const s=this.reverseBits(i,n);if(s>i){const r=t[i];t[i]=t[s],t[s]=r;const a=o[i];o[i]=o[s],o[s]=a}}for(let i=2;i<=e;i*=2){const s=i/2,r=-2*Math.PI/i;for(let a=0;a<e;a+=i)for(let l=0;l<s;l++){const d=r*l,m=Math.cos(d),c=Math.sin(d),p=a+l,g=a+l+s,y=m*t[g]-c*o[g],x=c*t[g]+m*o[g];t[g]=t[p]-y,o[g]=o[p]-x,t[p]=t[p]+y,o[p]=o[p]+x}}}reverseBits(t,o){let e=0;for(let n=0;n<o;n++)e=e<<1|t&1,t>>=1;return e}downsampleSpectrum(t,o){const e=new Float32Array(o),n=t.length/o;for(let i=0;i<o;i++){const s=Math.floor(i*n),r=Math.floor((i+1)*n);let a=0;for(let l=s;l<r;l++)a+=t[l];e[i]=a/(r-s)}return e}calculateBandEnergy(t,o,e){let n=0;const i=Math.min(e,t.length)-o;for(let s=o;s<Math.min(e,t.length);s++)n+=t[s]*t[s];return i>0?Math.sqrt(n/i):0}normalizeArray(t){let o=0;for(let e=0;e<t.length;e++)t[e]>o&&(o=t[e]);if(o>0)for(let e=0;e<t.length;e++)t[e]=t[e]/o}yieldToUI(){return new Promise(t=>setTimeout(t,0))}static binToFrequency(t,o,e){return t*o/e}static frequencyToBin(t,o,e){return Math.round(t*e/o)}}class N{constructor(t=E.beatDetector.fps){F(this,"fps");this.fps=t}detectBeats(t,o){const e=this.detectOnsets(t),{bpm:n,confidence:i}=this.estimateTempo(e,o),s=60/n,r=this.generateBeatGrid(e,s,o);return{bpm:n,beats:r,confidence:i,beatInterval:s}}detectOnsets(t){const o=[],e=E.beatDetector,n=Math.floor(this.fps*e.onsetWindowSeconds),i=e.onsetThreshold;for(let s=n;s<t.length-n;s++){let r=0;for(let y=s-n;y<s+n;y++)r+=t[y];const a=r/(n*2),l=t[s],d=t[s-1],m=t[s+1],c=l>d&&l>m,p=l>a+i,g=l>e.onsetMinEnergy;if(c&&p&&g){const y=s/this.fps,x=o[o.length-1];(!x||y-x>e.onsetMinDistance)&&o.push(y)}}return o}estimateTempo(t,o){const e=E.beatDetector.tempo;if(t.length<4)return{bpm:e.fallbackBpm,confidence:0};const n=[];for(let m=1;m<t.length;m++){const c=t[m]-t[m-1];c>e.minInterval&&c<e.maxInterval&&n.push(c)}if(n.length<2)return{bpm:e.fallbackBpm,confidence:0};const i=new Map,s=e.histogramBin;for(const m of n){const c=Math.round(m/s)*s;i.set(c,(i.get(c)||0)+1)}let r=0,a=.5;for(const[m,c]of i)c>r&&(r=c,a=m);let l=60/a;for(;l<e.normalizeMinBpm;)l*=2;for(;l>e.normalizeMaxBpm;)l/=2;const d=Math.min(1,r/(n.length*e.confidenceDivisor));return{bpm:Math.round(l),confidence:d}}generateBeatGrid(t,o,e){const n=E.beatDetector.beatGrid,i=[];let s=0,r=0;for(let a=0;a<o;a+=n.offsetStep){let l=0;for(const d of t){const m=(d-a)%o;Math.min(m,o-m)<n.alignmentTolerance&&l++}l>r&&(r=l,s=a)}for(let a=s;a<e;a+=o)i.push(a);return i}static getBeatNumber(t,o,e=0){return Math.floor((t-e)/o)%4+1}static isOnBeat(t,o,e=.05){for(const n of o)if(Math.abs(t-n)<e)return!0;return!1}}export{q as A,N as B,W as F,E as T};
