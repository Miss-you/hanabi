import"./math-BLsufJHS.js";import{A as f,F as C,B as m}from"./BeatDetector-CNMq8YQG.js";class b{audioAnalyzer;frequencyAnalyzer;beatDetector;result=null;frequencyBands=null;beatInfo=null;audioBuffer=null;audioContext=null;source=null;startTime=0;isPlaying=!1;duration=0;spectrogramCanvas;spectrogramCtx;bassCanvas;bassCtx;midCanvas;midCtx;highCanvas;highCtx;beatCanvas;beatCtx;constructor(){this.audioAnalyzer=new f(window.innerHeight),this.frequencyAnalyzer=new C(2048,30),this.beatDetector=new m(30),this.spectrogramCanvas=document.getElementById("spectrogramCanvas"),this.bassCanvas=document.getElementById("bassCanvas"),this.midCanvas=document.getElementById("midCanvas"),this.highCanvas=document.getElementById("highCanvas"),this.beatCanvas=document.getElementById("beatCanvas"),this.spectrogramCtx=this.getContext(this.spectrogramCanvas),this.bassCtx=this.getContext(this.bassCanvas),this.midCtx=this.getContext(this.midCanvas),this.highCtx=this.getContext(this.highCanvas),this.beatCtx=this.getContext(this.beatCanvas),this.setupCanvases(),this.setupEventListeners(),this.loop()}getContext(t){const e=t.getContext("2d");if(!e)throw new Error("Cannot get canvas context");return e}setupCanvases(){const t=(e,i)=>{const a=e.getBoundingClientRect(),s=window.devicePixelRatio||1;e.width=a.width*s,e.height=a.height*s,i.scale(s,s)};t(this.spectrogramCanvas,this.spectrogramCtx),t(this.bassCanvas,this.bassCtx),t(this.midCanvas,this.midCtx),t(this.highCanvas,this.highCtx),t(this.beatCanvas,this.beatCtx),window.addEventListener("resize",()=>{[{canvas:this.spectrogramCanvas,ctx:this.spectrogramCtx},{canvas:this.bassCanvas,ctx:this.bassCtx},{canvas:this.midCanvas,ctx:this.midCtx},{canvas:this.highCanvas,ctx:this.highCtx},{canvas:this.beatCanvas,ctx:this.beatCtx}].forEach(({canvas:e,ctx:i})=>{i.setTransform(1,0,0,1,0,0),t(e,i)}),this.frequencyBands&&this.drawAllVisualizations()})}setupEventListeners(){const t=document.getElementById("audioInput"),e=document.getElementById("playBtn"),i=document.getElementById("stopBtn"),a=document.getElementById("exportBtn");t?.addEventListener("change",s=>this.handleFileUpload(s)),e?.addEventListener("click",()=>this.play()),i?.addEventListener("click",()=>this.stop()),a?.addEventListener("click",()=>this.exportJSON())}async handleFileUpload(t){const i=t.target.files?.[0];if(!i)return;const a=document.getElementById("fileName");a&&(a.textContent=i.name),this.setStatus("加载音频中...");try{const s=await i.arrayBuffer();this.audioContext=new AudioContext,this.audioBuffer=await this.audioContext.decodeAudioData(s),this.duration=this.audioBuffer.duration,this.setStatus("分析频谱..."),this.frequencyBands=await this.frequencyAnalyzer.analyze(this.audioBuffer,{onProgress:n=>this.setStatus(`分析频谱: ${Math.round(n*100)}%`)}),this.setStatus("检测节拍..."),this.beatInfo=this.beatDetector.detectBeats(this.frequencyBands.bass,this.duration),this.setStatus("提取事件..."),this.result=await this.audioAnalyzer.analyze(this.audioBuffer,{onProgress:n=>this.setStatus(`提取事件: ${Math.round(n*100)}%`)}),this.updateBpmDisplay(),this.drawAllVisualizations(),this.setStatus(`分析完成: BPM=${this.beatInfo.bpm}, ${this.result.timeline.length}个事件`),this.enableControls()}catch(s){console.error("Analysis failed:",s),this.setStatus("分析失败")}}updateBpmDisplay(){if(!this.beatInfo)return;const t=document.getElementById("bpmValue"),e=document.getElementById("confidenceValue");t&&(t.textContent=String(this.beatInfo.bpm)),e&&(e.textContent=`${Math.round(this.beatInfo.confidence*100)}%`)}drawAllVisualizations(){this.drawSpectrogram(),this.drawBandEnergy(this.bassCtx,this.bassCanvas,this.frequencyBands?.bass,"#ff5555"),this.drawBandEnergy(this.midCtx,this.midCanvas,this.frequencyBands?.mid,"#55ff55"),this.drawBandEnergy(this.highCtx,this.highCanvas,this.frequencyBands?.high,"#5599ff"),this.drawBeatGrid(),this.drawTimeline()}drawSpectrogram(){if(!this.frequencyBands)return;const t=this.spectrogramCtx,e=this.spectrogramCanvas.getBoundingClientRect(),{spectrogram:i,frequencyBinCount:a}=this.frequencyBands;t.clearRect(0,0,e.width,e.height),t.fillStyle="#000",t.fillRect(0,0,e.width,e.height);const s=i.length,n=Math.min(a,256),o=e.width/s,r=e.height/n;for(let h=0;h<s;h++){const l=i[h];if(l)for(let c=0;c<n;c++){const d=l[c]??0,u=Math.min(1,d*3),g=240-u*240,y=80,p=u*50;t.fillStyle=`hsl(${g}, ${y}%, ${p}%)`,t.fillRect(h*o,e.height-(c+1)*r,Math.ceil(o)+1,Math.ceil(r)+1)}}t.fillStyle="rgba(255, 255, 255, 0.5)",t.font="10px sans-serif",t.fillText("8kHz",5,15),t.fillText("2kHz",5,e.height*.5),t.fillText("200Hz",5,e.height-5)}drawBandEnergy(t,e,i,a){if(!i)return;const s=e.getBoundingClientRect();t.clearRect(0,0,s.width,s.height),t.fillStyle="rgba(0, 0, 0, 0.5)",t.fillRect(0,0,s.width,s.height);const n=s.width/i.length;t.fillStyle=a;for(let o=0;o<i.length;o++){const h=(i[o]??0)*s.height*.9;t.fillRect(o*n,s.height-h,Math.max(1,n-.5),h)}t.strokeStyle="rgba(255, 255, 255, 0.3)",t.setLineDash([3,3]),t.beginPath(),t.moveTo(0,s.height*.5),t.lineTo(s.width,s.height*.5),t.stroke(),t.setLineDash([])}drawBeatGrid(){if(!this.beatInfo)return;const t=this.beatCtx,e=this.beatCanvas.getBoundingClientRect(),{beats:i,beatInterval:a}=this.beatInfo;t.clearRect(0,0,e.width,e.height),t.fillStyle="rgba(0, 0, 0, 0.5)",t.fillRect(0,0,e.width,e.height);const s=this.duration;for(let n=0;n<i.length;n++){const o=i[n],r=o/s*e.width,l=m.getBeatNumber(o,a,i[0]??0)===1;t.fillStyle=l?"#ffaa00":"rgba(255, 170, 0, 0.5)",t.fillRect(r-1,l?5:15,2,l?e.height-10:e.height-30),l&&n%4===0&&(t.fillStyle="rgba(255, 255, 255, 0.6)",t.font="10px sans-serif",t.fillText(String(Math.floor(n/4)+1),r+4,e.height-5))}t.fillStyle="rgba(255, 255, 255, 0.4)",t.font="9px sans-serif",t.fillText("小节",5,12)}drawTimeline(){if(!this.result)return;const t=document.getElementById("timelineContainer");if(!t)return;const{timeline:e,duration:i}=this.result,a=t.querySelectorAll(".timeline-row");a.forEach(n=>{const o=n.querySelector(".events-area");o&&o.querySelectorAll(".timeline-event").forEach(r=>r.remove())});const s={bass:[],mid:[],piano:[],climax:[]};for(const n of e)n.isClimax?s.climax?.push(n):s[n.type]?.push(n);a.forEach(n=>{const o=n.getAttribute("data-type");if(!o)return;const r=n.querySelector(".events-area");if(!r)return;const h=s[o]||[],l=r.clientWidth;for(const c of h){const d=document.createElement("div");d.className=`timeline-event ${o}`,d.style.left=`${c.explodeTime/i*l}px`,d.style.width="4px",r.appendChild(d)}})}async play(){if(!(!this.audioBuffer||!this.audioContext)){if(this.audioContext.state==="suspended"&&await this.audioContext.resume(),this.source)try{this.source.stop()}catch{}this.source=this.audioContext.createBufferSource(),this.source.buffer=this.audioBuffer,this.source.connect(this.audioContext.destination),this.source.start(0),this.startTime=this.audioContext.currentTime,this.isPlaying=!0,this.setPlayheadsVisible(!0),this.source.onended=()=>{this.isPlaying=!1,this.setPlayheadsVisible(!1)}}}stop(){if(this.source)try{this.source.stop()}catch{}this.isPlaying=!1,this.setPlayheadsVisible(!1)}setPlayheadsVisible(t){document.querySelectorAll(".playhead").forEach(i=>{i.style.display=t?"block":"none"})}exportJSON(){if(!this.result||!this.beatInfo)return;const t={...JSON.parse(f.exportJSON(this.result)),bpm:this.beatInfo.bpm,beats:this.beatInfo.beats,beatConfidence:this.beatInfo.confidence},e=JSON.stringify(t,null,2),i=new Blob([e],{type:"application/json"}),a=URL.createObjectURL(i),s=document.createElement("a");s.href=a,s.download="audio-analysis.json",s.click(),URL.revokeObjectURL(a)}enableControls(){const t=document.getElementById("playBtn"),e=document.getElementById("stopBtn"),i=document.getElementById("exportBtn");t&&(t.disabled=!1),e&&(e.disabled=!1),i&&(i.disabled=!1)}setStatus(t){const e=document.getElementById("status");e&&(e.textContent=t)}formatTime(t){const e=Math.floor(t/60),i=Math.floor(t%60);return`${e.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`}loop=()=>{if(requestAnimationFrame(this.loop),this.isPlaying&&this.audioContext&&this.duration>0){const t=this.audioContext.currentTime-this.startTime,e=t/this.duration,i=this.spectrogramCanvas.getBoundingClientRect(),a=this.beatCanvas.getBoundingClientRect(),s=document.getElementById("spectrogramPlayhead"),n=document.getElementById("beatPlayhead");s&&(s.style.left=`${e*i.width}px`),n&&(n.style.left=`${e*a.width}px`);const o=document.getElementById("progressFill");o&&(o.style.width=`${e*100}%`);const r=document.getElementById("timeDisplay");r&&(r.textContent=`${this.formatTime(t)} / ${this.formatTime(this.duration)}`)}}}new b;
