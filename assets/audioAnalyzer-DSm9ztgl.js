var x=Object.defineProperty;var v=(d,t,e)=>t in d?x(d,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):d[t]=e;var n=(d,t,e)=>v(d,typeof t!="symbol"?t+"":t,e);import"./math-CmfUW7_Q.js";import{A as y,F as B,B as C}from"./BeatDetector-DOah_MSb.js";class w{constructor(){n(this,"audioAnalyzer");n(this,"frequencyAnalyzer");n(this,"beatDetector");n(this,"result",null);n(this,"frequencyBands",null);n(this,"beatInfo",null);n(this,"audioBuffer",null);n(this,"audioContext",null);n(this,"source",null);n(this,"startTime",0);n(this,"isPlaying",!1);n(this,"duration",0);n(this,"spectrogramCanvas");n(this,"spectrogramCtx");n(this,"bassCanvas");n(this,"bassCtx");n(this,"midCanvas");n(this,"midCtx");n(this,"highCanvas");n(this,"highCtx");n(this,"beatCanvas");n(this,"beatCtx");n(this,"loop",()=>{if(requestAnimationFrame(this.loop),this.isPlaying&&this.audioContext&&this.duration>0){const t=this.audioContext.currentTime-this.startTime,e=t/this.duration,s=this.spectrogramCanvas.getBoundingClientRect(),a=this.beatCanvas.getBoundingClientRect(),i=document.getElementById("spectrogramPlayhead"),o=document.getElementById("beatPlayhead");i&&(i.style.left=`${e*s.width}px`),o&&(o.style.left=`${e*a.width}px`);const r=document.getElementById("progressFill");r&&(r.style.width=`${e*100}%`);const h=document.getElementById("timeDisplay");h&&(h.textContent=`${this.formatTime(t)} / ${this.formatTime(this.duration)}`)}});this.audioAnalyzer=new y(window.innerHeight),this.frequencyAnalyzer=new B(2048,30),this.beatDetector=new C(30),this.spectrogramCanvas=document.getElementById("spectrogramCanvas"),this.bassCanvas=document.getElementById("bassCanvas"),this.midCanvas=document.getElementById("midCanvas"),this.highCanvas=document.getElementById("highCanvas"),this.beatCanvas=document.getElementById("beatCanvas"),this.spectrogramCtx=this.getContext(this.spectrogramCanvas),this.bassCtx=this.getContext(this.bassCanvas),this.midCtx=this.getContext(this.midCanvas),this.highCtx=this.getContext(this.highCanvas),this.beatCtx=this.getContext(this.beatCanvas),this.setupCanvases(),this.setupEventListeners(),this.loop()}getContext(t){const e=t.getContext("2d");if(!e)throw new Error("Cannot get canvas context");return e}setupCanvases(){const t=(e,s)=>{const a=e.getBoundingClientRect(),i=window.devicePixelRatio||1;e.width=a.width*i,e.height=a.height*i,s.scale(i,i)};t(this.spectrogramCanvas,this.spectrogramCtx),t(this.bassCanvas,this.bassCtx),t(this.midCanvas,this.midCtx),t(this.highCanvas,this.highCtx),t(this.beatCanvas,this.beatCtx),window.addEventListener("resize",()=>{[{canvas:this.spectrogramCanvas,ctx:this.spectrogramCtx},{canvas:this.bassCanvas,ctx:this.bassCtx},{canvas:this.midCanvas,ctx:this.midCtx},{canvas:this.highCanvas,ctx:this.highCtx},{canvas:this.beatCanvas,ctx:this.beatCtx}].forEach(({canvas:e,ctx:s})=>{s.setTransform(1,0,0,1,0,0),t(e,s)}),this.frequencyBands&&this.drawAllVisualizations()})}setupEventListeners(){const t=document.getElementById("audioInput"),e=document.getElementById("playBtn"),s=document.getElementById("stopBtn"),a=document.getElementById("exportBtn");t==null||t.addEventListener("change",i=>this.handleFileUpload(i)),e==null||e.addEventListener("click",()=>this.play()),s==null||s.addEventListener("click",()=>this.stop()),a==null||a.addEventListener("click",()=>this.exportJSON())}async handleFileUpload(t){var i;const s=(i=t.target.files)==null?void 0:i[0];if(!s)return;const a=document.getElementById("fileName");a&&(a.textContent=s.name),this.setStatus("加载音频中...");try{const o=await s.arrayBuffer();this.audioContext=new AudioContext,this.audioBuffer=await this.audioContext.decodeAudioData(o),this.duration=this.audioBuffer.duration,this.setStatus("分析频谱..."),this.frequencyBands=await this.frequencyAnalyzer.analyze(this.audioBuffer,{onProgress:r=>this.setStatus(`分析频谱: ${Math.round(r*100)}%`)}),this.setStatus("检测节拍..."),this.beatInfo=this.beatDetector.detectBeats(this.frequencyBands.bass,this.duration),this.setStatus("提取事件..."),this.result=await this.audioAnalyzer.analyze(this.audioBuffer,{onProgress:r=>this.setStatus(`提取事件: ${Math.round(r*100)}%`)}),this.updateBpmDisplay(),this.drawAllVisualizations(),this.setStatus(`分析完成: BPM=${this.beatInfo.bpm}, ${this.result.timeline.length}个事件`),this.enableControls()}catch(o){console.error("Analysis failed:",o),this.setStatus("分析失败")}}updateBpmDisplay(){if(!this.beatInfo)return;const t=document.getElementById("bpmValue"),e=document.getElementById("confidenceValue");t&&(t.textContent=String(this.beatInfo.bpm)),e&&(e.textContent=`${Math.round(this.beatInfo.confidence*100)}%`)}drawAllVisualizations(){var t,e,s;this.drawSpectrogram(),this.drawBandEnergy(this.bassCtx,this.bassCanvas,(t=this.frequencyBands)==null?void 0:t.bass,"#ff5555"),this.drawBandEnergy(this.midCtx,this.midCanvas,(e=this.frequencyBands)==null?void 0:e.mid,"#55ff55"),this.drawBandEnergy(this.highCtx,this.highCanvas,(s=this.frequencyBands)==null?void 0:s.high,"#5599ff"),this.drawBeatGrid(),this.drawTimeline()}drawSpectrogram(){if(!this.frequencyBands)return;const t=this.spectrogramCtx,e=this.spectrogramCanvas.getBoundingClientRect(),{spectrogram:s,frequencyBinCount:a}=this.frequencyBands;t.clearRect(0,0,e.width,e.height),t.fillStyle="#000",t.fillRect(0,0,e.width,e.height);const i=s.length,o=Math.min(a,256),r=e.width/i,h=e.height/o;for(let l=0;l<i;l++){const c=s[l];if(c)for(let u=0;u<o;u++){const g=c[u]??0,m=Math.min(1,g*3),f=240-m*240,p=80,b=m*50;t.fillStyle=`hsl(${f}, ${p}%, ${b}%)`,t.fillRect(l*r,e.height-(u+1)*h,Math.ceil(r)+1,Math.ceil(h)+1)}}t.fillStyle="rgba(255, 255, 255, 0.5)",t.font="10px sans-serif",t.fillText("8kHz",5,15),t.fillText("2kHz",5,e.height*.5),t.fillText("200Hz",5,e.height-5)}drawBandEnergy(t,e,s,a){if(!s)return;const i=e.getBoundingClientRect();t.clearRect(0,0,i.width,i.height),t.fillStyle="rgba(0, 0, 0, 0.5)",t.fillRect(0,0,i.width,i.height);const o=i.width/s.length;t.fillStyle=a;for(let r=0;r<s.length;r++){const l=(s[r]??0)*i.height*.9;t.fillRect(r*o,i.height-l,Math.max(1,o-.5),l)}t.strokeStyle="rgba(255, 255, 255, 0.3)",t.setLineDash([3,3]),t.beginPath(),t.moveTo(0,i.height*.5),t.lineTo(i.width,i.height*.5),t.stroke(),t.setLineDash([])}drawBeatGrid(){if(!this.beatInfo)return;const t=this.beatCtx,e=this.beatCanvas.getBoundingClientRect(),{beats:s,beatInterval:a}=this.beatInfo;t.clearRect(0,0,e.width,e.height),t.fillStyle="rgba(0, 0, 0, 0.5)",t.fillRect(0,0,e.width,e.height);const i=this.duration;for(let o=0;o<s.length;o++){const r=s[o],h=r/i*e.width,c=C.getBeatNumber(r,a,s[0]??0)===1;t.fillStyle=c?"#ffaa00":"rgba(255, 170, 0, 0.5)",t.fillRect(h-1,c?5:15,2,c?e.height-10:e.height-30),c&&o%4===0&&(t.fillStyle="rgba(255, 255, 255, 0.6)",t.font="10px sans-serif",t.fillText(String(Math.floor(o/4)+1),h+4,e.height-5))}t.fillStyle="rgba(255, 255, 255, 0.4)",t.font="9px sans-serif",t.fillText("小节",5,12)}drawTimeline(){var o,r;if(!this.result)return;const t=document.getElementById("timelineContainer");if(!t)return;const{timeline:e,duration:s}=this.result,a=t.querySelectorAll(".timeline-row");a.forEach(h=>{const l=h.querySelector(".events-area");l&&l.querySelectorAll(".timeline-event").forEach(c=>c.remove())});const i={bass:[],mid:[],piano:[],climax:[]};for(const h of e)h.isClimax?(o=i.climax)==null||o.push(h):(r=i[h.type])==null||r.push(h);a.forEach(h=>{const l=h.getAttribute("data-type");if(!l)return;const c=h.querySelector(".events-area");if(!c)return;const u=i[l]||[],g=c.clientWidth;for(const m of u){const f=document.createElement("div");f.className=`timeline-event ${l}`,f.style.left=`${m.explodeTime/s*g}px`,f.style.width="4px",c.appendChild(f)}})}async play(){if(!(!this.audioBuffer||!this.audioContext)){if(this.audioContext.state==="suspended"&&await this.audioContext.resume(),this.source)try{this.source.stop()}catch{}this.source=this.audioContext.createBufferSource(),this.source.buffer=this.audioBuffer,this.source.connect(this.audioContext.destination),this.source.start(0),this.startTime=this.audioContext.currentTime,this.isPlaying=!0,this.setPlayheadsVisible(!0),this.source.onended=()=>{this.isPlaying=!1,this.setPlayheadsVisible(!1)}}}stop(){if(this.source)try{this.source.stop()}catch{}this.isPlaying=!1,this.setPlayheadsVisible(!1)}setPlayheadsVisible(t){document.querySelectorAll(".playhead").forEach(s=>{s.style.display=t?"block":"none"})}exportJSON(){if(!this.result||!this.beatInfo)return;const t={...JSON.parse(y.exportJSON(this.result)),bpm:this.beatInfo.bpm,beats:this.beatInfo.beats,beatConfidence:this.beatInfo.confidence},e=JSON.stringify(t,null,2),s=new Blob([e],{type:"application/json"}),a=URL.createObjectURL(s),i=document.createElement("a");i.href=a,i.download="audio-analysis.json",i.click(),URL.revokeObjectURL(a)}enableControls(){const t=document.getElementById("playBtn"),e=document.getElementById("stopBtn"),s=document.getElementById("exportBtn");t&&(t.disabled=!1),e&&(e.disabled=!1),s&&(s.disabled=!1)}setStatus(t){const e=document.getElementById("status");e&&(e.textContent=t)}formatTime(t){const e=Math.floor(t/60),s=Math.floor(t%60);return`${e.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`}}new w;
