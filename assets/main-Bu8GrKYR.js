var S=Object.defineProperty;var E=(f,e,t)=>e in f?S(f,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):f[e]=t;var o=(f,e,t)=>E(f,typeof e!="symbol"?e+"":e,t);import{g as x,r as d}from"./math-CmfUW7_Q.js";import{V as w}from"./Particle-BIbDLJ2h.js";import{F as T}from"./Firework-bLsaGrCq.js";import{A as b,F as C,B as k}from"./BeatDetector--57tYSAC.js";class A{constructor(e){o(this,"canvas");o(this,"ctx");o(this,"dpr",1);o(this,"width",0);o(this,"height",0);this.canvas=e;const t=e.getContext("2d");if(!t)throw new Error("Failed to get 2D context");this.ctx=t,this.resize(),window.addEventListener("resize",()=>this.resize())}get context(){return this.ctx}resize(){this.dpr=window.devicePixelRatio||1,this.width=window.innerWidth,this.height=window.innerHeight,this.canvas.width=Math.floor(this.width*this.dpr),this.canvas.height=Math.floor(this.height*this.dpr),this.canvas.style.width=`${this.width}px`,this.canvas.style.height=`${this.height}px`,this.ctx.scale(this.dpr,this.dpr)}drawBackground(){this.ctx.globalAlpha=1,this.ctx.globalCompositeOperation="source-over";const e=this.ctx.createLinearGradient(0,0,0,this.height);e.addColorStop(0,w.SKY_GRADIENT_TOP),e.addColorStop(1,w.SKY_GRADIENT_BOTTOM),this.ctx.fillStyle=e,this.ctx.fillRect(0,0,this.width,this.height),this.ctx.fillStyle="rgba(0, 5, 20, 0.2)",this.ctx.fillRect(0,0,this.width,this.height)}drawWater(){const e=this.height*(1-w.WATER_HEIGHT_RATIO);this.ctx.globalCompositeOperation="source-over";const t=this.ctx.createLinearGradient(0,e,0,this.height);t.addColorStop(0,"rgba(0, 5, 20, 0.6)"),t.addColorStop(1,"#000"),this.ctx.fillStyle=t,this.ctx.fillRect(0,e,this.width,this.height-e)}setLighterBlend(){this.ctx.globalCompositeOperation="lighter"}resetBlend(){this.ctx.globalCompositeOperation="source-over"}get horizonY(){return this.height*(1-w.WATER_HEIGHT_RATIO)}}class P{constructor(){o(this,"particles",[])}get count(){return this.particles.length}add(e){Array.isArray(e)?this.particles.push(...e):this.particles.push(e)}update(){for(let e=this.particles.length-1;e>=0;e--){const t=this.particles[e];t.update(),t.isAlive||this.particles.splice(e,1)}}draw(e,t){for(const n of this.particles)n.draw(e,t)}clear(){this.particles=[]}getParticles(){return this.particles}}class I{constructor(e,t,n){o(this,"fireworks",[]);o(this,"screenWidth");o(this,"screenHeight");o(this,"onParticlesCreated");this.screenWidth=e,this.screenHeight=t,this.onParticlesCreated=n}resize(e,t){this.screenWidth=e,this.screenHeight=t}get count(){return this.fireworks.length}launch(e,t=!1,n,s=.5,i){const u=i??x(this.screenWidth),a=n??d(this.screenHeight*.1,this.screenHeight*.4),h=d(0,360),r=new T(u,a,e,h,this.screenHeight,this.screenWidth,{onExplode:this.onParticlesCreated},s);t?r.explodeNow():this.fireworks.push(r)}launchAt(e,t,n,s,i,u=!1){const a=new T(t,n,e,i,this.screenHeight,this.screenWidth,{onExplode:this.onParticlesCreated},s);u?a.explodeNow():this.fireworks.push(a)}launchMultiple(e){for(const t of e)t.delay&&t.delay>0?setTimeout(()=>{this.launchAt(t.type,t.x,t.targetY,t.energy,t.hue,t.instant)},t.delay):this.launchAt(t.type,t.x,t.targetY,t.energy,t.hue,t.instant)}salvo(e,t=50){for(let n=0;n<e;n++)setTimeout(()=>{const s=Math.random()>.4?"willow":Math.random()>.5?"kiku":"botan",i=Math.random()>.9,u=this.screenHeight*d(.1,.5);this.launch(s,i,u,d(.3,.8))},n*t)}getScreenWidth(){return this.screenWidth}getScreenHeight(){return this.screenHeight}update(){for(let e=this.fireworks.length-1;e>=0;e--){const t=this.fireworks[e];t.update(),t.dead&&this.fireworks.splice(e,1)}}draw(e){for(const t of this.fireworks)t.draw(e)}clear(){this.fireworks=[]}}class Y{constructor(e){o(this,"events",[]);o(this,"currentIndex",0);o(this,"startTime",0);o(this,"audioContext",null);o(this,"source",null);o(this,"callbacks");o(this,"lastSalvoTime",-10);o(this,"isPlaying",!1);o(this,"isPaused",!1);this.callbacks=e}loadEvents(e){this.events=[...e],this.currentIndex=0,this.lastSalvoTime=-10}async play(e){if(this.audioContext||(this.audioContext=new AudioContext),this.audioContext.state==="suspended"&&await this.audioContext.resume(),this.source)try{this.source.stop()}catch{}this.source=this.audioContext.createBufferSource(),this.source.buffer=e,this.source.connect(this.audioContext.destination),this.source.start(0),this.startTime=this.audioContext.currentTime,this.currentIndex=0,this.isPlaying=!0,this.isPaused=!1,this.source.onended=()=>{this.isPlaying=!1}}async pause(){this.audioContext&&this.audioContext.state==="running"&&(await this.audioContext.suspend(),this.isPaused=!0)}async resume(){this.audioContext&&this.audioContext.state==="suspended"&&(await this.audioContext.resume(),this.isPaused=!1)}stop(){if(this.source){try{this.source.stop()}catch{}this.source=null}this.isPlaying=!1,this.isPaused=!1,this.currentIndex=0}get currentTime(){return!this.audioContext||!this.isPlaying?0:this.audioContext.currentTime-this.startTime}update(){var t,n;if(!this.isPlaying||this.isPaused)return;const e=this.currentTime;for((n=(t=this.callbacks).onTick)==null||n.call(t,e);this.currentIndex<this.events.length&&this.events[this.currentIndex].launchTime<=e;){const s=this.events[this.currentIndex];this.fireEvent(s,e),this.currentIndex++}}fireEvent(e,t){var n,s,i,u,a,h,r,c;switch(e.type){case"bass":e.isClimax&&t-this.lastSalvoTime>2?((s=(n=this.callbacks).onClimax)==null||s.call(n,e),this.lastSalvoTime=t):(u=(i=this.callbacks).onBass)==null||u.call(i,e);break;case"mid":(h=(a=this.callbacks).onMid)==null||h.call(a,e);break;case"piano":(c=(r=this.callbacks).onPiano)==null||c.call(r,e);break}}getEvents(){return this.events}static eventToFireworkType(e,t){switch(e){case"bass":return t||Math.random()>.6?"willow":"kiku";case"mid":return"botan";case"piano":return"botan";default:return"kiku"}}}class M{execute(e,t){const n=e.getScreenWidth(),s=e.getScreenHeight(),i=t.x??d(n*.2,n*.8),u=t.targetY??s*d(.15,.35),a=t.energy??.5,h=t.hue??d(0,360),r=t.type??"botan";e.launchAt(r,i,u,a,h)}}class B{execute(e,t){const n=e.getScreenWidth(),s=e.getScreenHeight(),i=t.count??15,u=t.interval??50,a=t.spread??.6;for(let h=0;h<i;h++)setTimeout(()=>{const r=d(n*(.5-a/2),n*(.5+a/2)),c=s*d(.1,.4),l=d(.4,.8),g=t.hue??d(0,360),p=Math.random()>.5?"willow":"kiku",m=Math.random()>.9;e.launchAt(p,r,c,l,g,m)},h*u)}}class H{execute(e,t){const n=e.getScreenWidth(),s=e.getScreenHeight(),i=t.count??8,u=t.direction??"left",h=(t.duration??1e3)/i;for(let r=0;r<i;r++)setTimeout(()=>{let c;const l=r/(i-1);switch(u){case"left":c=n*(.1+l*.8);break;case"right":c=n*(.9-l*.8);break;case"center":c=n*(.5+(l-.5)*.6);break;case"outward":c=r%2===0?n*(.5-l*.4):n*(.5+l*.4);break;default:c=n*(.1+l*.8)}const g=s*d(.15,.35),p=t.energy??.5,m=(t.hue??0)+r*15,y=t.type??"kiku";e.launchAt(y,c,g,p,m%360)},r*h)}}class W{execute(e,t){const n=e.getScreenWidth(),s=e.getScreenHeight(),i=t.count??2,u=t.spread??.3,a=n/2;for(let h=0;h<i;h++){const r=(h+1)*u*n/(i+1),c=s*d(.15,.35),l=t.energy??.6,g=t.hue??d(0,360),p=t.type??"kiku";e.launchAt(p,a-r,c,l,g),e.launchAt(p,a+r,c,l,g)}}}class R{execute(e,t){const n=e.getScreenWidth(),s=e.getScreenHeight(),i=t.count??5,u=t.interval??200,a=s*.4,h=s*.1;for(let r=0;r<i;r++)setTimeout(()=>{const c=r/(i-1),l=n*(.3+c*.4),g=a-c*(a-h),p=.4+c*.4,m=(t.hue??30)+r*20,y=t.type??"botan";e.launchAt(y,l,g,p,m%360)},r*u)}}class z{execute(e,t){const n=e.getScreenWidth(),s=e.getScreenHeight(),i=t.count??4,u=t.interval??500;for(let a=0;a<i;a++)setTimeout(()=>{const h=a%4===0,r=d(n*.2,n*.8),c=s*(h?.15:.25),l=h?.8:.5,g=t.hue??d(0,360),p=h?"kiku":"botan";e.launchAt(p,r,c,l,g)},a*u)}}class D{execute(e,t){const n=e.getScreenWidth(),s=e.getScreenHeight(),i=t.count??4,u=t.x??n*d(.3,.7),a=t.targetY??s*d(.15,.3),h=t.hue??d(0,360),r=["kiku","botan","willow"];for(let c=0;c<i;c++)setTimeout(()=>{const l=d(-30,30),g=d(-20,20),p=(h+c*30)%360,m=r[c%r.length],y=d(.5,.8);e.launchAt(m,u+l,a+g,y,p)},c*30)}}class L{execute(e,t){const n=e.getScreenWidth(),s=e.getScreenHeight(),i=t.count??3,u=t.interval??150,a=s*.25;for(let h=0;h<i;h++)setTimeout(()=>{const r=(h+1)*.15,c=(t.hue??0)+h*40,l=t.type??"kiku",g=t.energy??.6;e.launchAt(l,n*r,a,g,c),e.launchAt(l,n*(1-r),a,g,(c+180)%360)},h*u)}}class F{execute(e,t){const n=e.getScreenWidth(),s=e.getScreenHeight(),i=t.count??5,u=t.duration??2e3,a=t.energy??.4;for(let h=0;h<i;h++)setTimeout(()=>{const r=d(n*.1,n*.9),c=s*d(.2,.5),l=Math.max(.35,a*d(.8,1.2)),g=t.hue??d(30,60);e.launchAt("piano",r,c,l,g)},d(0,u))}}class _{execute(e,t){const n=e.getScreenWidth(),s=e.getScreenHeight(),i=t.energy??1,u=Math.floor(30*i);for(let a=0;a<u/3;a++)setTimeout(()=>{const h=d(n*.1,n*.9),r=s*d(.15,.4),c=d(.5,.8),l=d(0,360),g=Math.random()>.5?"kiku":"botan";e.launchAt(g,h,r,c,l)},d(0,1e3));for(let a=0;a<u/2;a++)setTimeout(()=>{const h=d(n*.05,n*.95),r=s*d(.1,.35),c=d(.7,1),l=d(0,360),g=Math.random()>.3?"willow":"kiku",p=Math.random()>.7;e.launchAt(g,h,r,c,l,p)},1e3+d(0,1e3));for(let a=0;a<u/6;a++)setTimeout(()=>{const h=d(.1,.4)*n,r=s*d(.1,.25),c=.9,l=d(0,60);e.launchAt("willow",n/2-h,r,c,l),e.launchAt("willow",n/2+h,r,c,l)},2e3+a*100)}}class O{constructor(){o(this,"patterns",new Map);this.registerBuiltinPatterns()}registerBuiltinPatterns(){this.patterns.set("single",new M),this.patterns.set("salvo",new B),this.patterns.set("cascade",new H),this.patterns.set("symmetric",new W),this.patterns.set("rising",new R),this.patterns.set("pulse",new z),this.patterns.set("cluster",new D),this.patterns.set("cross",new L),this.patterns.set("scatter",new F),this.patterns.set("finale",new _)}get(e){const t=this.patterns.get(e);if(!t)throw new Error(`Unknown pattern type: ${e}`);return t}execute(e,t,n){this.get(e).execute(t,n)}has(e){return this.patterns.has(e)}}class v{constructor(e=4,t=8){o(this,"windowSize");o(this,"minSectionDuration");this.windowSize=e,this.minSectionDuration=t}detect(e,t){if(e.length===0||t<=0)return[this.createSection("verse",0,t,.5,0)];const n=this.createWindows(e,t);this.calculateTrends(n);const s=this.classifyWindows(n,t),i=this.mergeSections(s);return this.applyMinDuration(i,t)}createWindows(e,t){const n=[],s=Math.ceil(t/this.windowSize);for(let i=0;i<s;i++){const u=i*this.windowSize,a=Math.min((i+1)*this.windowSize,t),h=e.filter(l=>l.explodeTime>=u&&l.explodeTime<a),r=h.length>0?h.reduce((l,g)=>l+g.energy,0)/h.length:0,c=h.filter(l=>l.isClimax).length;n.push({startTime:u,endTime:a,avgEnergy:r,eventCount:h.length,climaxCount:c,trend:"stable"})}return n}calculateTrends(e){for(let t=1;t<e.length;t++){const n=e[t-1],s=e[t],i=s.avgEnergy-n.avgEnergy;i>.1?s.trend="rising":i<-.1?s.trend="falling":s.trend="stable"}}classifyWindows(e,t){const n=[],s=e.map(r=>r.avgEnergy).filter(r=>r>0),i=s.length>0?s.reduce((r,c)=>r+c,0)/s.length:.5,u=Math.max(...s,.5),a=i+(u-i)*.5,h=i*.5;for(const r of e){let c;const{avgEnergy:l,climaxCount:g,trend:p,eventCount:m}=r;g>2||l>a*.95?c="climax":l>a*.7&&m>5?c="chorus":p==="rising"&&l>i*.8?c="prechorus":l<h||m<2?r.startTime<t*.15?c="intro":r.endTime>t*.85?c="outro":c="bridge":c="verse",n.push(this.createSection(c,r.startTime,r.endTime,l,m/this.windowSize))}return n}mergeSections(e){if(e.length===0)return[];const t=[];let n={...e[0]};for(let s=1;s<e.length;s++){const i=e[s];i.type===n.type?(n.endTime=i.endTime,n.energy=(n.energy+i.energy)/2,n.density=(n.density+i.density)/2):(t.push(n),n={...i})}return t.push(n),t}applyMinDuration(e,t){const n=[];for(const s of e)if(s.endTime-s.startTime<this.minSectionDuration&&n.length>0){const u=n[n.length-1];u.endTime=s.endTime,u.energy=(u.energy+s.energy)/2,u.density=(u.density+s.density)/2}else n.push(s);return n.length===0&&n.push(this.createSection("verse",0,t,.5,0)),n}createSection(e,t,n,s,i){return{type:e,startTime:t,endTime:n,energy:s,density:i}}static getSectionAt(e,t){for(const n of e)if(t>=n.startTime&&t<n.endTime)return n;return null}static isNearTransition(e,t,n=.5){for(const s of e)if(Math.abs(t-s.startTime)<n)return!0;return!1}}class G{constructor(){o(this,"rules",[]);o(this,"ruleStates",new Map);this.registerDefaultRules()}registerDefaultRules(){this.addRule({id:"finale",priority:100,cooldown:10,exclusive:!0,condition:e=>e.duration-e.currentTime<10&&e.currentEvent.energy>.6,action:e=>({pattern:"finale",launchTime:e.currentTime,params:{duration:0,targetY:e.screenHeight*.2,energy:e.currentEvent.energy}})}),this.addRule({id:"climax_salvo",priority:90,cooldown:2,exclusive:!0,condition:e=>{var t;return((t=e.currentSection)==null?void 0:t.type)==="climax"&&e.currentEvent.isClimax&&e.currentEvent.type==="bass"},action:e=>({pattern:"salvo",launchTime:e.currentTime,params:{duration:0,targetY:e.screenHeight*.2,count:Math.floor(15+e.currentEvent.energy*10),interval:40,energy:e.currentEvent.energy}})}),this.addRule({id:"beat_drop",priority:85,cooldown:4,exclusive:!0,condition:e=>!e.beatInfo||e.recentEvents.length<3||!e.beatInfo.beats.some(s=>Math.abs(s-e.currentTime)<.1)?!1:e.recentEvents.slice(-3).reduce((s,i)=>s+i.energy,0)/3<.3&&e.currentEvent.energy>.6,action:e=>({pattern:"cluster",launchTime:e.currentTime,params:{duration:0,targetY:e.screenHeight*.2,count:5,energy:e.currentEvent.energy,x:e.screenWidth/2}})}),this.addRule({id:"section_transition",priority:80,cooldown:8,exclusive:!1,condition:e=>e.currentSection?e.currentTime-e.currentSection.startTime<.5:!1,action:e=>({pattern:{intro:"scatter",verse:"single",prechorus:"rising",chorus:"symmetric",bridge:"cross",climax:"salvo",outro:"scatter"}[e.currentSection.type]||"single",launchTime:e.currentTime,params:{duration:0,targetY:e.screenHeight*.25,energy:e.currentEvent.energy}})}),this.addRule({id:"chorus_symmetric",priority:70,cooldown:1.5,exclusive:!1,condition:e=>{var t;return((t=e.currentSection)==null?void 0:t.type)==="chorus"&&e.currentEvent.type==="bass"&&e.currentEvent.energy>.5},action:e=>({pattern:"symmetric",launchTime:e.currentTime,params:{duration:0,targetY:e.currentEvent.targetY,count:2,spread:.25,energy:e.currentEvent.energy}})}),this.addRule({id:"piano_beat_sync",priority:60,cooldown:.3,exclusive:!1,condition:e=>{if(e.currentEvent.type!=="piano"||!e.beatInfo)return!1;const t=e.beatInfo.beats.reduce((n,s)=>Math.abs(s-e.currentEvent.explodeTime)<Math.abs(n-e.currentEvent.explodeTime)?s:n,e.beatInfo.beats[0]??0);return Math.abs(t-e.currentEvent.explodeTime)<.05},action:e=>({pattern:"single",launchTime:e.currentTime,params:{duration:0,targetY:e.currentEvent.targetY,energy:Math.max(.5,e.currentEvent.energy*.9),type:"piano",hue:45}})}),this.addRule({id:"bass_impact",priority:50,cooldown:.35,exclusive:!1,condition:e=>e.currentEvent.type==="bass"&&e.currentEvent.energy>.4,action:e=>({pattern:"single",launchTime:e.currentTime,params:{duration:0,targetY:e.currentEvent.targetY,energy:e.currentEvent.energy,type:e.currentEvent.isClimax?"willow":"kiku"}})}),this.addRule({id:"mid_accent",priority:40,cooldown:.2,exclusive:!1,condition:e=>e.currentEvent.type==="mid"&&e.currentEvent.energy>.3,action:e=>({pattern:"single",launchTime:e.currentTime,params:{duration:0,targetY:e.currentEvent.targetY,energy:e.currentEvent.energy*.8,type:"botan"}})}),this.addRule({id:"ambient_scatter",priority:20,cooldown:3,exclusive:!1,condition:e=>{var t;return e.currentEvent.type==="piano"&&((t=e.currentSection)==null?void 0:t.type)!=="climax"&&e.currentEvent.energy<.3},action:e=>({pattern:"scatter",launchTime:e.currentTime,params:{duration:0,targetY:e.screenHeight*.4,count:3,energy:.45}})}),this.rules.sort((e,t)=>t.priority-e.priority)}addRule(e){this.rules.push(e),this.rules.sort((t,n)=>n.priority-t.priority),this.ruleStates.set(e.id,{lastFired:-1/0})}evaluate(e){const t=[];for(const n of this.rules){const s=this.ruleStates.get(n.id)??{lastFired:-1/0};if(e.currentTime-s.lastFired<n.cooldown||!n.condition(e))continue;const i=n.action(e);if(i&&(t.push(i),s.lastFired=e.currentTime,this.ruleStates.set(n.id,s),n.exclusive))break}return t}reset(){for(const[e]of this.ruleStates)this.ruleStates.set(e,{lastFired:-1/0})}getRule(e){return this.rules.find(t=>t.id===e)}setRuleCooldown(e,t){const n=this.getRule(e);n&&(n.cooldown=t)}}class N{constructor(){o(this,"patternLibrary");o(this,"sectionDetector");o(this,"ruleEngine");o(this,"launcher",null);o(this,"sections",[]);o(this,"events",[]);o(this,"beatInfo",null);o(this,"duration",0);o(this,"scheduledCommands",[]);o(this,"currentEventIndex",0);o(this,"recentEvents",[]);o(this,"recentEventsWindow",2);o(this,"recentLaunches",[]);o(this,"launchTrackingWindow",3);o(this,"minEnergyFloor",.55);o(this,"sparseThreshold",3);this.patternLibrary=new O,this.sectionDetector=new v,this.ruleEngine=new G}setLauncher(e){this.launcher=e}prepareTrack(e){this.events=[...e.events].sort((t,n)=>t.explodeTime-n.explodeTime),this.beatInfo=e.beatInfo,this.duration=e.duration,this.sections=this.sectionDetector.detect(this.events,this.duration),this.reset(),console.log("[Choreographer] Track prepared:",{events:this.events.length,sections:this.sections.length,bpm:this.beatInfo.bpm,duration:this.duration}),console.log("[Choreographer] Detected sections:",this.sections)}reset(){this.currentEventIndex=0,this.recentEvents=[],this.scheduledCommands=[],this.recentLaunches=[],this.ruleEngine.reset()}update(e){if(!(!this.launcher||this.events.length===0)){for(;this.currentEventIndex<this.events.length&&this.events[this.currentEventIndex].explodeTime<=e+.5;){const t=this.events[this.currentEventIndex];this.processEvent(t,e),this.currentEventIndex++}this.executeScheduledCommands(e),this.recentEvents=this.recentEvents.filter(t=>e-t.explodeTime<this.recentEventsWindow)}}processEvent(e,t){if(!this.launcher)return;this.recentEvents.push(e);const n={currentTime:t,currentEvent:e,currentSection:v.getSectionAt(this.sections,t),beatInfo:this.beatInfo,duration:this.duration,screenWidth:this.launcher.getScreenWidth(),screenHeight:this.launcher.getScreenHeight(),recentEvents:[...this.recentEvents]},s=this.ruleEngine.evaluate(n);for(const i of s)this.scheduleCommand(i)}scheduleCommand(e){this.scheduledCommands.push({command:e,executed:!1})}executeScheduledCommands(e){if(this.launcher){for(const t of this.scheduledCommands)t.executed||e>=t.command.launchTime&&(this.executeCommand(t.command),t.executed=!0);this.scheduledCommands=this.scheduledCommands.filter(t=>!t.executed)}}executeCommand(e){if(!this.launcher)return;const t=e.launchTime;this.recentLaunches=this.recentLaunches.filter(u=>t-u<this.launchTrackingWindow);const n=this.recentLaunches.length,s=n<=this.sparseThreshold,i={...e.params};if(s&&i.energy!==void 0){const u=1+(this.sparseThreshold-n)*.15,a=Math.max(this.minEnergyFloor,i.energy*u);i.energy=Math.min(1,a)}else s&&i.energy===void 0&&(i.energy=this.minEnergyFloor);this.recentLaunches.push(t);try{this.patternLibrary.execute(e.pattern,this.launcher,i)}catch(u){console.warn("[Choreographer] Failed to execute pattern:",e.pattern,u)}}getCurrentSection(e){return v.getSectionAt(this.sections,e)}getSections(){return[...this.sections]}getBeatInfo(){return this.beatInfo}isNearTransition(e,t=.5){return v.isNearTransition(this.sections,e,t)}triggerPattern(e,t={}){if(!this.launcher)return;const n={duration:0,targetY:this.launcher.getScreenHeight()*.25,energy:.6};this.patternLibrary.execute(e,this.launcher,{...n,...t})}getStats(){var t;const e={};for(const n of this.sections)e[n.type]=(e[n.type]||0)+1;return{totalEvents:this.events.length,totalSections:this.sections.length,sectionBreakdown:e,bpm:((t=this.beatInfo)==null?void 0:t.bpm)??0,duration:this.duration}}}class q{constructor(){o(this,"renderer");o(this,"particleSystem");o(this,"launcher");o(this,"audioAnalyzer");o(this,"frequencyAnalyzer");o(this,"beatDetector");o(this,"choreographer");o(this,"timeline");o(this,"mode","idle");o(this,"isPaused",!1);o(this,"demoTimer",0);o(this,"audioBuffer",null);o(this,"loop",()=>{requestAnimationFrame(this.loop),!this.isPaused&&(this.renderer.drawBackground(),this.mode==="music"?this.timeline.update():this.mode==="demo"&&this.runDemoLogic(),this.renderer.setLighterBlend(),this.launcher.update(),this.launcher.draw(this.renderer.context),this.particleSystem.update(),this.particleSystem.draw(this.renderer.context,this.renderer.height),this.renderer.drawWater())});const e=document.getElementById("canvas");if(!e)throw new Error("Canvas not found");this.renderer=new A(e),this.particleSystem=new P,this.launcher=new I(this.renderer.width,this.renderer.height,t=>this.particleSystem.add(t)),this.audioAnalyzer=new b(this.renderer.height),this.frequencyAnalyzer=new C,this.beatDetector=new k,this.choreographer=new N,this.choreographer.setLauncher(this.launcher),this.timeline=new Y({onTick:t=>this.choreographer.update(t)}),this.setupEventListeners(),this.setupResize(),this.loop()}setupEventListeners(){const e=document.getElementById("demoBtn"),t=document.getElementById("pauseBtn"),n=document.getElementById("audioInput");e==null||e.addEventListener("click",()=>this.startDemo()),t==null||t.addEventListener("click",()=>this.togglePause()),n==null||n.addEventListener("change",s=>this.handleAudioUpload(s))}setupResize(){window.addEventListener("resize",()=>{this.launcher.resize(this.renderer.width,this.renderer.height),this.audioAnalyzer.resize(this.renderer.height)})}startDemo(){this.mode="demo",this.demoTimer=0,this.timeline.stop(),this.setStatus("模式: 演示 (自动编排)")}togglePause(){if(this.mode==="idle")return;const e=document.getElementById("pauseBtn");this.isPaused?(this.isPaused=!1,e&&(e.textContent="暂停"),this.timeline.resume()):(this.isPaused=!0,e&&(e.textContent="继续"),this.timeline.pause())}async handleAudioUpload(e){var s;const n=(s=e.target.files)==null?void 0:s[0];if(n){this.mode="music",this.setStatus("加载音频中...");try{const i=await n.arrayBuffer(),u=new AudioContext;this.audioBuffer=await u.decodeAudioData(i);const a=this.audioBuffer.duration;this.setStatus("分析音频事件... (1/3)");const h=await this.audioAnalyzer.analyze(this.audioBuffer,{onProgress:g=>{this.setStatus(`分析事件: ${Math.round(g*100)}%`)}});this.setStatus("分析频率特征... (2/3)");const r=await this.frequencyAnalyzer.analyze(this.audioBuffer);this.setStatus("检测节拍... (3/3)");const c=this.beatDetector.detectBeats(r.bass,a);this.setStatus("准备编排..."),this.choreographer.prepareTrack({events:h.timeline,beatInfo:c,freqBands:r,duration:a}),this.timeline.loadEvents(h.timeline);const l=this.choreographer.getStats();console.log("[HanabiApp] Choreography ready:",l),this.setStatus(`正在播放: ${n.name} | BPM: ${Math.round(l.bpm)}`),await this.timeline.play(this.audioBuffer)}catch(i){console.error("Audio loading failed:",i),this.setStatus("音频加载失败"),this.mode="idle"}}}runDemoLogic(){this.demoTimer++;let e=.98;if(this.demoTimer>300&&(e=.95),this.demoTimer>900&&(e=.85),Math.random()>e){const t=this.demoTimer>900?Math.random()>.5?"willow":"kiku":this.demoTimer>300?"kiku":"botan";this.launcher.launch(t)}this.demoTimer>1300&&(this.demoTimer=0)}setStatus(e){const t=document.getElementById("status");t&&(t.textContent=e)}}new q;
