var x=Object.defineProperty;var b=(m,t,e)=>t in m?x(m,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):m[t]=e;var c=(m,t,e)=>b(m,typeof t!="symbol"?t+"":t,e);import{g as C,r as d}from"./math-CmfUW7_Q.js";import{V as v}from"./Particle-BIbDLJ2h.js";import{F as T}from"./Firework-bLsaGrCq.js";import{T as p,A as k,F as A,B as P}from"./BeatDetector-DOah_MSb.js";class B{constructor(t){c(this,"canvas");c(this,"ctx");c(this,"dpr",1);c(this,"width",0);c(this,"height",0);this.canvas=t;const e=t.getContext("2d");if(!e)throw new Error("Failed to get 2D context");this.ctx=e,this.resize(),window.addEventListener("resize",()=>this.resize())}get context(){return this.ctx}resize(){this.dpr=window.devicePixelRatio||1,this.width=window.innerWidth,this.height=window.innerHeight,this.canvas.width=Math.floor(this.width*this.dpr),this.canvas.height=Math.floor(this.height*this.dpr),this.canvas.style.width=`${this.width}px`,this.canvas.style.height=`${this.height}px`,this.ctx.scale(this.dpr,this.dpr)}drawBackground(){this.ctx.globalAlpha=1,this.ctx.globalCompositeOperation="source-over";const t=this.ctx.createLinearGradient(0,0,0,this.height);t.addColorStop(0,v.SKY_GRADIENT_TOP),t.addColorStop(1,v.SKY_GRADIENT_BOTTOM),this.ctx.fillStyle=t,this.ctx.fillRect(0,0,this.width,this.height),this.ctx.fillStyle="rgba(0, 5, 20, 0.2)",this.ctx.fillRect(0,0,this.width,this.height)}drawWater(){const t=this.height*(1-v.WATER_HEIGHT_RATIO);this.ctx.globalCompositeOperation="source-over";const e=this.ctx.createLinearGradient(0,t,0,this.height);e.addColorStop(0,"rgba(0, 5, 20, 0.6)"),e.addColorStop(1,"#000"),this.ctx.fillStyle=e,this.ctx.fillRect(0,t,this.width,this.height-t)}setLighterBlend(){this.ctx.globalCompositeOperation="lighter"}resetBlend(){this.ctx.globalCompositeOperation="source-over"}get horizonY(){return this.height*(1-v.WATER_HEIGHT_RATIO)}}class D{constructor(){c(this,"particles",[])}get count(){return this.particles.length}add(t){Array.isArray(t)?this.particles.push(...t):this.particles.push(t)}update(){for(let t=this.particles.length-1;t>=0;t--){const e=this.particles[t];e.update(),e.isAlive||this.particles.splice(t,1)}}draw(t,e){for(const n of this.particles)n.draw(t,e)}clear(){this.particles=[]}getParticles(){return this.particles}}class I{constructor(t,e,n){c(this,"fireworks",[]);c(this,"screenWidth");c(this,"screenHeight");c(this,"onParticlesCreated");this.screenWidth=t,this.screenHeight=e,this.onParticlesCreated=n}resize(t,e){this.screenWidth=t,this.screenHeight=e}get count(){return this.fireworks.length}launch(t,e=!1,n,i=.5,s){const r=s??C(this.screenWidth),o=n??d(this.screenHeight*.1,this.screenHeight*.4),h=d(0,360),l=new T(r,o,t,h,this.screenHeight,this.screenWidth,{onExplode:this.onParticlesCreated},i);e?l.explodeNow():this.fireworks.push(l)}launchAt(t,e,n,i,s,r=!1){const o=new T(e,n,t,s,this.screenHeight,this.screenWidth,{onExplode:this.onParticlesCreated},i);r?o.explodeNow():this.fireworks.push(o)}launchMultiple(t){for(const e of t)e.delay&&e.delay>0?setTimeout(()=>{this.launchAt(e.type,e.x,e.targetY,e.energy,e.hue,e.instant)},e.delay):this.launchAt(e.type,e.x,e.targetY,e.energy,e.hue,e.instant)}salvo(t,e=50){for(let n=0;n<t;n++)setTimeout(()=>{const i=Math.random()>.4?"willow":Math.random()>.5?"kiku":"botan",s=Math.random()>.9,r=this.screenHeight*d(.1,.5);this.launch(i,s,r,d(.3,.8))},n*e)}getScreenWidth(){return this.screenWidth}getScreenHeight(){return this.screenHeight}update(){for(let t=this.fireworks.length-1;t>=0;t--){const e=this.fireworks[t];e.update(),e.dead&&this.fireworks.splice(t,1)}}draw(t){for(const e of this.fireworks)e.draw(t)}clear(){this.fireworks=[]}}class M{constructor(t){c(this,"events",[]);c(this,"currentIndex",0);c(this,"startTime",0);c(this,"audioContext",null);c(this,"source",null);c(this,"callbacks");c(this,"lastSalvoTime",p.timeline.initialSalvoTime);c(this,"isPlaying",!1);c(this,"isPaused",!1);this.callbacks=t}loadEvents(t){this.events=[...t],this.currentIndex=0,this.lastSalvoTime=p.timeline.initialSalvoTime}async play(t){if(this.audioContext||(this.audioContext=new AudioContext),this.audioContext.state==="suspended"&&await this.audioContext.resume(),this.source)try{this.source.stop()}catch{}this.source=this.audioContext.createBufferSource(),this.source.buffer=t,this.source.connect(this.audioContext.destination),this.source.start(0),this.startTime=this.audioContext.currentTime,this.currentIndex=0,this.isPlaying=!0,this.isPaused=!1,this.source.onended=()=>{this.isPlaying=!1}}async pause(){this.audioContext&&this.audioContext.state==="running"&&(await this.audioContext.suspend(),this.isPaused=!0)}async resume(){this.audioContext&&this.audioContext.state==="suspended"&&(await this.audioContext.resume(),this.isPaused=!1)}stop(){if(this.source){try{this.source.stop()}catch{}this.source=null}this.isPlaying=!1,this.isPaused=!1,this.currentIndex=0}async close(){if(this.stop(),this.audioContext){try{await this.audioContext.close()}catch{}this.audioContext=null}}get currentTime(){return!this.audioContext||!this.isPlaying?0:this.audioContext.currentTime-this.startTime}update(){var e,n;if(!this.isPlaying||this.isPaused)return;const t=this.currentTime;for((n=(e=this.callbacks).onTick)==null||n.call(e,t);this.currentIndex<this.events.length&&this.events[this.currentIndex].launchTime<=t;){const i=this.events[this.currentIndex];this.fireEvent(i,t),this.currentIndex++}}fireEvent(t,e){var n,i,s,r,o,h,l,a;switch(t.type){case"bass":t.isClimax&&e-this.lastSalvoTime>p.timeline.climaxCooldown?((i=(n=this.callbacks).onClimax)==null||i.call(n,t),this.lastSalvoTime=e):(r=(s=this.callbacks).onBass)==null||r.call(s,t);break;case"mid":(h=(o=this.callbacks).onMid)==null||h.call(o,t);break;case"piano":(a=(l=this.callbacks).onPiano)==null||a.call(l,t);break}}getEvents(){return this.events}static eventToFireworkType(t,e){switch(t){case"bass":return e||Math.random()>p.timeline.climaxWillowRoll?"willow":"kiku";case"mid":return"botan";case"piano":return"botan";default:return"kiku"}}}class Y{execute(t,e){const n=t.getScreenWidth(),i=t.getScreenHeight(),s=e.x??d(n*.2,n*.8),r=e.targetY??i*d(.15,.35),o=e.energy??.5,h=e.hue??d(0,360),l=e.type??"botan";t.launchAt(l,s,r,o,h)}}class W{execute(t,e){const n=t.getScreenWidth(),i=t.getScreenHeight(),s=e.count??15,r=e.interval??50,o=e.spread??.6;for(let h=0;h<s;h++)setTimeout(()=>{const l=d(n*(.5-o/2),n*(.5+o/2)),a=i*d(.1,.4),u=d(.4,.8),g=e.hue??d(0,360),f=Math.random()>.5?"willow":"kiku",y=Math.random()>.9;t.launchAt(f,l,a,u,g,y)},h*r)}}class H{execute(t,e){const n=t.getScreenWidth(),i=t.getScreenHeight(),s=e.count??8,r=e.direction??"left",h=(e.duration??1e3)/s;for(let l=0;l<s;l++)setTimeout(()=>{let a;const u=l/(s-1);switch(r){case"left":a=n*(.1+u*.8);break;case"right":a=n*(.9-u*.8);break;case"center":a=n*(.5+(u-.5)*.6);break;case"outward":a=l%2===0?n*(.5-u*.4):n*(.5+u*.4);break;default:a=n*(.1+u*.8)}const g=i*d(.15,.35),f=e.energy??.5,y=(e.hue??0)+l*15,w=e.type??"kiku";t.launchAt(w,a,g,f,y%360)},l*h)}}class R{execute(t,e){const n=t.getScreenWidth(),i=t.getScreenHeight(),s=e.count??2,r=e.spread??.3,o=n/2;for(let h=0;h<s;h++){const l=(h+1)*r*n/(s+1),a=i*d(.15,.35),u=e.energy??.6,g=e.hue??d(0,360),f=e.type??"kiku";t.launchAt(f,o-l,a,u,g),t.launchAt(f,o+l,a,u,g)}}}class F{execute(t,e){const n=t.getScreenWidth(),i=t.getScreenHeight(),s=e.count??5,r=e.interval??200,o=i*.4,h=i*.1;for(let l=0;l<s;l++)setTimeout(()=>{const a=l/(s-1),u=n*(.3+a*.4),g=o-a*(o-h),f=.4+a*.4,y=(e.hue??30)+l*20,w=e.type??"botan";t.launchAt(w,u,g,f,y%360)},l*r)}}class L{execute(t,e){const n=t.getScreenWidth(),i=t.getScreenHeight(),s=e.count??4,r=e.interval??500;for(let o=0;o<s;o++)setTimeout(()=>{const h=o%4===0,l=d(n*.2,n*.8),a=i*(h?.15:.25),u=h?.8:.5,g=e.hue??d(0,360),f=h?"kiku":"botan";t.launchAt(f,l,a,u,g)},o*r)}}class z{execute(t,e){const n=t.getScreenWidth(),i=t.getScreenHeight(),s=e.count??4,r=e.x??n*d(.3,.7),o=e.targetY??i*d(.15,.3),h=e.hue??d(0,360),l=["kiku","botan","willow"];for(let a=0;a<s;a++)setTimeout(()=>{const u=d(-30,30),g=d(-20,20),f=(h+a*30)%360,y=l[a%l.length],w=d(.5,.8);t.launchAt(y,r+u,o+g,w,f)},a*30)}}class _{execute(t,e){const n=t.getScreenWidth(),i=t.getScreenHeight(),s=e.count??3,r=e.interval??150,o=i*.25;for(let h=0;h<s;h++)setTimeout(()=>{const l=(h+1)*.15,a=(e.hue??0)+h*40,u=e.type??"kiku",g=e.energy??.6;t.launchAt(u,n*l,o,g,a),t.launchAt(u,n*(1-l),o,g,(a+180)%360)},h*r)}}class O{execute(t,e){const n=t.getScreenWidth(),i=t.getScreenHeight(),s=e.count??5,r=e.duration??2e3,o=e.energy??.4;for(let h=0;h<s;h++)setTimeout(()=>{const l=d(n*.1,n*.9),a=i*d(.2,.5),u=Math.max(.35,o*d(.8,1.2)),g=e.hue??d(30,60);t.launchAt("piano",l,a,u,g)},d(0,r))}}class N{execute(t,e){const n=t.getScreenWidth(),i=t.getScreenHeight(),s=e.energy??1,r=Math.floor(30*s);for(let o=0;o<r/3;o++)setTimeout(()=>{const h=d(n*.1,n*.9),l=i*d(.15,.4),a=d(.5,.8),u=d(0,360),g=Math.random()>.5?"kiku":"botan";t.launchAt(g,h,l,a,u)},d(0,1e3));for(let o=0;o<r/2;o++)setTimeout(()=>{const h=d(n*.05,n*.95),l=i*d(.1,.35),a=d(.7,1),u=d(0,360),g=Math.random()>.3?"willow":"kiku",f=Math.random()>.7;t.launchAt(g,h,l,a,u,f)},1e3+d(0,1e3));for(let o=0;o<r/6;o++)setTimeout(()=>{const h=d(.1,.4)*n,l=i*d(.1,.25),a=.9,u=d(0,60);t.launchAt("willow",n/2-h,l,a,u),t.launchAt("willow",n/2+h,l,a,u)},2e3+o*100)}}class U{constructor(){c(this,"patterns",new Map);this.registerBuiltinPatterns()}registerBuiltinPatterns(){this.patterns.set("single",new Y),this.patterns.set("salvo",new W),this.patterns.set("cascade",new H),this.patterns.set("symmetric",new R),this.patterns.set("rising",new F),this.patterns.set("pulse",new L),this.patterns.set("cluster",new z),this.patterns.set("cross",new _),this.patterns.set("scatter",new O),this.patterns.set("finale",new N)}get(t){const e=this.patterns.get(t);if(!e)throw new Error(`Unknown pattern type: ${t}`);return e}execute(t,e,n){this.get(t).execute(e,n)}has(t){return this.patterns.has(t)}}class S{constructor(t=p.sectionDetector.windowSize,e=p.sectionDetector.minSectionDuration){c(this,"windowSize");c(this,"minSectionDuration");this.windowSize=t,this.minSectionDuration=e}detect(t,e){if(t.length===0||e<=0)return[this.createSection("verse",0,e,p.sectionDetector.defaultEnergy,0)];const n=this.createWindows(t,e);this.calculateTrends(n);const i=this.classifyWindows(n,e),s=this.mergeSections(i);return this.applyMinDuration(s,e)}createWindows(t,e){const n=[],i=Math.ceil(e/this.windowSize);for(let s=0;s<i;s++){const r=s*this.windowSize,o=Math.min((s+1)*this.windowSize,e),h=t.filter(u=>u.explodeTime>=r&&u.explodeTime<o),l=h.length>0?h.reduce((u,g)=>u+g.energy,0)/h.length:0,a=h.filter(u=>u.isClimax).length;n.push({startTime:r,endTime:o,avgEnergy:l,eventCount:h.length,climaxCount:a,trend:"stable"})}return n}calculateTrends(t){const e=p.sectionDetector.trendThreshold;for(let n=1;n<t.length;n++){const i=t[n-1],s=t[n],r=s.avgEnergy-i.avgEnergy;r>e?s.trend="rising":r<-e?s.trend="falling":s.trend="stable"}}classifyWindows(t,e){const n=[],i=p.sectionDetector,s=t.map(a=>a.avgEnergy).filter(a=>a>0),r=s.length>0?s.reduce((a,u)=>a+u,0)/s.length:i.defaultEnergy,o=Math.max(...s,i.defaultEnergy),h=r+(o-r)*i.highThresholdFactor,l=r*i.lowThresholdFactor;for(const a of t){let u;const{avgEnergy:g,climaxCount:f,trend:y,eventCount:w}=a;f>i.climaxCountThreshold||g>h*i.climaxEnergyFactor?u="climax":g>h*i.chorusEnergyFactor&&w>i.chorusEventCount?u="chorus":y==="rising"&&g>r*i.prechorusEnergyFactor?u="prechorus":g<l||w<i.lowEventCount?a.startTime<e*i.introPosition?u="intro":a.endTime>e*i.outroPosition?u="outro":u="bridge":u="verse",n.push(this.createSection(u,a.startTime,a.endTime,g,w/this.windowSize))}return n}mergeSections(t){if(t.length===0)return[];const e=[];let n={...t[0]};for(let i=1;i<t.length;i++){const s=t[i];s.type===n.type?(n.endTime=s.endTime,n.energy=(n.energy+s.energy)/2,n.density=(n.density+s.density)/2):(e.push(n),n={...s})}return e.push(n),e}applyMinDuration(t,e){const n=[];for(const i of t)if(i.endTime-i.startTime<this.minSectionDuration&&n.length>0){const r=n[n.length-1];r.endTime=i.endTime,r.energy=(r.energy+i.energy)/2,r.density=(r.density+i.density)/2}else n.push(i);return n.length===0&&n.push(this.createSection("verse",0,e,p.sectionDetector.defaultEnergy,0)),n}createSection(t,e,n,i,s){return{type:t,startTime:e,endTime:n,energy:i,density:s}}static getSectionAt(t,e){for(const n of t)if(e>=n.startTime&&e<n.endTime)return n;return null}static isNearTransition(t,e,n=p.sectionDetector.transitionThreshold){for(const i of t)if(Math.abs(e-i.startTime)<n)return!0;return!1}}class G{constructor(){c(this,"rules",[]);c(this,"ruleStates",new Map);this.registerDefaultRules()}registerDefaultRules(){const t=p.ruleEngine;this.addRule({id:"finale",priority:100,cooldown:t.finale.cooldown,exclusive:!0,condition:e=>e.duration-e.currentTime<t.finale.remainingSeconds&&e.currentEvent.energy>t.finale.minEnergy,action:e=>({pattern:"finale",launchTime:e.currentTime,params:{duration:0,targetY:e.screenHeight*t.finale.targetY,energy:e.currentEvent.energy}})}),this.addRule({id:"climax_salvo",priority:90,cooldown:t.climaxSalvo.cooldown,exclusive:!0,condition:e=>{var n;return((n=e.currentSection)==null?void 0:n.type)==="climax"&&e.currentEvent.isClimax&&e.currentEvent.type==="bass"},action:e=>({pattern:"salvo",launchTime:e.currentTime,params:{duration:0,targetY:e.screenHeight*t.climaxSalvo.targetY,count:Math.floor(t.climaxSalvo.countBase+e.currentEvent.energy*t.climaxSalvo.countEnergyScale),interval:t.climaxSalvo.intervalMs,energy:e.currentEvent.energy}})}),this.addRule({id:"beat_drop",priority:85,cooldown:t.beatDrop.cooldown,exclusive:!0,condition:e=>{const n=t.beatDrop.recentEnergyWindow;return!e.beatInfo||e.recentEvents.length<n||!e.beatInfo.beats.some(r=>Math.abs(r-e.currentTime)<t.beatDrop.nearBeatTolerance)?!1:e.recentEvents.slice(-n).reduce((r,o)=>r+o.energy,0)/n<t.beatDrop.recentEnergyThreshold&&e.currentEvent.energy>t.beatDrop.minEnergy},action:e=>({pattern:"cluster",launchTime:e.currentTime,params:{duration:0,targetY:e.screenHeight*t.beatDrop.targetY,count:t.beatDrop.count,energy:e.currentEvent.energy,x:e.screenWidth/2}})}),this.addRule({id:"section_transition",priority:80,cooldown:t.sectionTransition.cooldown,exclusive:!1,condition:e=>e.currentSection?e.currentTime-e.currentSection.startTime<t.sectionTransition.nearStartWindow:!1,action:e=>({pattern:{intro:"scatter",verse:"single",prechorus:"rising",chorus:"symmetric",bridge:"cross",climax:"salvo",outro:"scatter"}[e.currentSection.type]||"single",launchTime:e.currentTime,params:{duration:0,targetY:e.screenHeight*t.sectionTransition.targetY,energy:e.currentEvent.energy}})}),this.addRule({id:"chorus_symmetric",priority:70,cooldown:t.chorusSymmetric.cooldown,exclusive:!1,condition:e=>{var n;return((n=e.currentSection)==null?void 0:n.type)==="chorus"&&e.currentEvent.type==="bass"&&e.currentEvent.energy>t.chorusSymmetric.minEnergy},action:e=>({pattern:"symmetric",launchTime:e.currentTime,params:{duration:0,targetY:e.currentEvent.targetY,count:2,spread:t.chorusSymmetric.spread,energy:e.currentEvent.energy}})}),this.addRule({id:"piano_beat_sync",priority:60,cooldown:t.pianoBeatSync.cooldown,exclusive:!1,condition:e=>{if(e.currentEvent.type!=="piano"||!e.beatInfo)return!1;const n=e.beatInfo.beats.reduce((i,s)=>Math.abs(s-e.currentEvent.explodeTime)<Math.abs(i-e.currentEvent.explodeTime)?s:i,e.beatInfo.beats[0]??0);return Math.abs(n-e.currentEvent.explodeTime)<t.pianoBeatSync.beatTolerance},action:e=>({pattern:"single",launchTime:e.currentTime,params:{duration:0,targetY:e.currentEvent.targetY,energy:Math.max(t.pianoBeatSync.minEnergy,e.currentEvent.energy*t.pianoBeatSync.energyScale),type:"piano",hue:t.pianoBeatSync.hue}})}),this.addRule({id:"bass_impact",priority:50,cooldown:t.bassImpact.cooldown,exclusive:!1,condition:e=>e.currentEvent.type==="bass"&&e.currentEvent.energy>t.bassImpact.minEnergy,action:e=>({pattern:"single",launchTime:e.currentTime,params:{duration:0,targetY:e.currentEvent.targetY,energy:e.currentEvent.energy,type:e.currentEvent.isClimax?"willow":"kiku"}})}),this.addRule({id:"mid_accent",priority:40,cooldown:t.midAccent.cooldown,exclusive:!1,condition:e=>e.currentEvent.type==="mid"&&e.currentEvent.energy>t.midAccent.minEnergy,action:e=>({pattern:"single",launchTime:e.currentTime,params:{duration:0,targetY:e.currentEvent.targetY,energy:e.currentEvent.energy*t.midAccent.energyScale,type:"botan"}})}),this.addRule({id:"ambient_scatter",priority:20,cooldown:t.ambientScatter.cooldown,exclusive:!1,condition:e=>{var n;return e.currentEvent.type==="piano"&&((n=e.currentSection)==null?void 0:n.type)!=="climax"&&e.currentEvent.energy<t.ambientScatter.maxEnergy},action:e=>({pattern:"scatter",launchTime:e.currentTime,params:{duration:0,targetY:e.screenHeight*t.ambientScatter.targetY,count:t.ambientScatter.count,energy:t.ambientScatter.energy}})}),this.rules.sort((e,n)=>n.priority-e.priority)}addRule(t){this.rules.push(t),this.rules.sort((e,n)=>n.priority-e.priority),this.ruleStates.set(t.id,{lastFired:-1/0})}evaluate(t){const e=[];for(const n of this.rules){const i=this.ruleStates.get(n.id)??{lastFired:-1/0};if(t.currentTime-i.lastFired<n.cooldown||!n.condition(t))continue;const s=n.action(t);if(s&&(e.push(s),i.lastFired=t.currentTime,this.ruleStates.set(n.id,i),n.exclusive))break}return e}reset(){for(const[t]of this.ruleStates)this.ruleStates.set(t,{lastFired:-1/0})}getRule(t){return this.rules.find(e=>e.id===t)}setRuleCooldown(t,e){const n=this.getRule(t);n&&(n.cooldown=e)}}const E=(...m)=>{};class ${constructor(){c(this,"patternLibrary");c(this,"sectionDetector");c(this,"ruleEngine");c(this,"launcher",null);c(this,"sections",[]);c(this,"events",[]);c(this,"beatInfo",null);c(this,"duration",0);c(this,"scheduledCommands",[]);c(this,"currentEventIndex",0);c(this,"recentEvents",[]);c(this,"recentEventsWindow",p.choreographer.recentEventsWindow);c(this,"recentLaunches",[]);c(this,"launchTrackingWindow",p.choreographer.launchTrackingWindow);c(this,"minEnergyFloor",p.choreographer.minEnergyFloor);c(this,"sparseThreshold",p.choreographer.sparseThreshold);this.patternLibrary=new U,this.sectionDetector=new S,this.ruleEngine=new G}setLauncher(t){this.launcher=t}prepareTrack(t){this.events=[...t.events].sort((e,n)=>e.explodeTime-n.explodeTime),this.beatInfo=t.beatInfo,this.duration=t.duration,this.sections=this.sectionDetector.detect(this.events,this.duration),this.reset(),E("[Choreographer] Track prepared:",{events:this.events.length,sections:this.sections.length,bpm:this.beatInfo.bpm,duration:this.duration}),E("[Choreographer] Detected sections:",this.sections)}reset(){this.currentEventIndex=0,this.recentEvents=[],this.scheduledCommands=[],this.recentLaunches=[],this.ruleEngine.reset()}update(t){if(!(!this.launcher||this.events.length===0)){for(;this.currentEventIndex<this.events.length&&this.events[this.currentEventIndex].explodeTime<=t+p.choreographer.lookAheadSeconds;){const e=this.events[this.currentEventIndex];this.processEvent(e,t),this.currentEventIndex++}this.executeScheduledCommands(t),this.recentEvents=this.recentEvents.filter(e=>t-e.explodeTime<this.recentEventsWindow)}}processEvent(t,e){if(!this.launcher)return;this.recentEvents.push(t);const n={currentTime:e,currentEvent:t,currentSection:S.getSectionAt(this.sections,e),beatInfo:this.beatInfo,duration:this.duration,screenWidth:this.launcher.getScreenWidth(),screenHeight:this.launcher.getScreenHeight(),recentEvents:[...this.recentEvents]},i=this.ruleEngine.evaluate(n);for(const s of i)this.scheduleCommand(s)}scheduleCommand(t){this.scheduledCommands.push({command:t,executed:!1})}executeScheduledCommands(t){if(this.launcher){for(const e of this.scheduledCommands)e.executed||t>=e.command.launchTime&&(this.executeCommand(e.command),e.executed=!0);this.scheduledCommands=this.scheduledCommands.filter(e=>!e.executed)}}executeCommand(t){if(!this.launcher)return;const e=t.launchTime;this.recentLaunches=this.recentLaunches.filter(r=>e-r<this.launchTrackingWindow);const n=this.recentLaunches.length,i=n<=this.sparseThreshold,s={...t.params};if(i&&s.energy!==void 0){const r=1+(this.sparseThreshold-n)*p.choreographer.sparseBoostPerMissing,o=Math.max(this.minEnergyFloor,s.energy*r);s.energy=Math.min(p.choreographer.energyCap,o)}else i&&s.energy===void 0&&(s.energy=this.minEnergyFloor);this.recentLaunches.push(e);try{this.patternLibrary.execute(t.pattern,this.launcher,s)}catch(r){console.warn("[Choreographer] Failed to execute pattern:",t.pattern,r)}}getCurrentSection(t){return S.getSectionAt(this.sections,t)}getSections(){return[...this.sections]}getBeatInfo(){return this.beatInfo}isNearTransition(t,e=p.sectionDetector.transitionThreshold){return S.isNearTransition(this.sections,t,e)}triggerPattern(t,e={}){if(!this.launcher)return;const n={duration:0,targetY:this.launcher.getScreenHeight()*p.choreographer.defaultTrigger.targetYFactor,energy:p.choreographer.defaultTrigger.energy};this.patternLibrary.execute(t,this.launcher,{...n,...e})}getStats(){var e;const t={};for(const n of this.sections)t[n.type]=(t[n.type]||0)+1;return{totalEvents:this.events.length,totalSections:this.sections.length,sectionBreakdown:t,bpm:((e=this.beatInfo)==null?void 0:e.bpm)??0,duration:this.duration}}}class q{constructor(){c(this,"renderer");c(this,"particleSystem");c(this,"launcher");c(this,"audioAnalyzer");c(this,"frequencyAnalyzer");c(this,"beatDetector");c(this,"choreographer");c(this,"timeline");c(this,"mode","idle");c(this,"isPaused",!1);c(this,"demoTimer",0);c(this,"audioBuffer",null);c(this,"loop",()=>{requestAnimationFrame(this.loop),!this.isPaused&&(this.renderer.drawBackground(),this.mode==="music"?this.timeline.update():this.mode==="demo"&&this.runDemoLogic(),this.renderer.setLighterBlend(),this.launcher.update(),this.launcher.draw(this.renderer.context),this.particleSystem.update(),this.particleSystem.draw(this.renderer.context,this.renderer.height),this.renderer.drawWater())});const t=document.getElementById("canvas");if(!t)throw new Error("Canvas not found");this.renderer=new B(t),this.particleSystem=new D,this.launcher=new I(this.renderer.width,this.renderer.height,e=>this.particleSystem.add(e)),this.audioAnalyzer=new k(this.renderer.height),this.frequencyAnalyzer=new A,this.beatDetector=new P,this.choreographer=new $,this.choreographer.setLauncher(this.launcher),this.timeline=new M({onTick:e=>this.choreographer.update(e)}),this.setupEventListeners(),this.setupResize(),this.loop()}setupEventListeners(){const t=document.getElementById("demoBtn"),e=document.getElementById("pauseBtn"),n=document.getElementById("audioInput");t==null||t.addEventListener("click",()=>this.startDemo()),e==null||e.addEventListener("click",()=>this.togglePause()),n==null||n.addEventListener("change",i=>this.handleAudioUpload(i))}setupResize(){window.addEventListener("resize",()=>{this.launcher.resize(this.renderer.width,this.renderer.height),this.audioAnalyzer.resize(this.renderer.height)})}startDemo(){this.mode="demo",this.demoTimer=0,this.timeline.close(),this.setStatus("模式: 演示 (自动编排)")}togglePause(){if(this.mode==="idle")return;const t=document.getElementById("pauseBtn");this.isPaused?(this.isPaused=!1,t&&(t.textContent="暂停"),this.timeline.resume()):(this.isPaused=!0,t&&(t.textContent="继续"),this.timeline.pause())}async handleAudioUpload(t){var i;const e=t.target,n=(i=e.files)==null?void 0:i[0];if(n){this.mode="music",this.isPaused=!1,this.setStatus("加载音频中...");try{await this.validateAudioFile(n),await this.timeline.close();const s=await n.arrayBuffer(),r=new AudioContext;try{this.audioBuffer=await r.decodeAudioData(s)}finally{await r.close()}const o=this.audioBuffer.duration;this.setStatus("分析音频事件... (1/3)");const h=await this.audioAnalyzer.analyze(this.audioBuffer,{onProgress:g=>{this.setStatus(`分析事件: ${Math.round(g*100)}%`)}});this.setStatus("分析频率特征... (2/3)");const l=await this.frequencyAnalyzer.analyze(this.audioBuffer);this.setStatus("检测节拍... (3/3)");const a=this.beatDetector.detectBeats(l.bass,o);this.setStatus("准备编排..."),this.choreographer.prepareTrack({events:h.timeline,beatInfo:a,freqBands:l,duration:o}),this.timeline.loadEvents(h.timeline);const u=this.choreographer.getStats();E("[HanabiApp] Choreography ready:",u),this.setStatus(`正在播放: ${n.name} | BPM: ${Math.round(u.bpm)}`),await this.timeline.play(this.audioBuffer)}catch(s){console.error("Audio loading failed:",s),this.setStatus(s instanceof Error?s.message:"音频加载失败"),this.mode="idle",this.audioBuffer=null}finally{e.value=""}}}runDemoLogic(){this.demoTimer++;const t=p.demo;let e=t.thresholdBase;if(this.demoTimer>t.midPhaseStart&&(e=t.thresholdMid),this.demoTimer>t.latePhaseStart&&(e=t.thresholdLate),Math.random()>e){const n=this.demoTimer>t.latePhaseStart?Math.random()>t.latePhaseWillowChance?"willow":"kiku":this.demoTimer>t.midPhaseStart?"kiku":"botan";this.launcher.launch(n)}this.demoTimer>t.resetAfter&&(this.demoTimer=0)}getFileExtension(t){const e=t.name.split(".");return e.length<2?null:e[e.length-1].toLowerCase()}async getAudioDuration(t){return new Promise((e,n)=>{const i=URL.createObjectURL(t),s=new Audio,r=()=>{URL.revokeObjectURL(i),s.src=""};s.preload="metadata",s.onloadedmetadata=()=>{const o=s.duration;r(),e(o)},s.onerror=()=>{r(),n(new Error("音频元数据读取失败"))},s.src=i})}async validateAudioFile(t){const e=p.audioUpload,n=this.getFileExtension(t),i=e.allowedMimeTypes.some(o=>o===t.type),s=n!==null&&e.allowedExtensions.some(o=>o===n);if(!i&&!s)throw new Error("不支持的音频格式，请使用 mp3/wav/ogg");if(t.size>e.maxFileBytes){const o=Math.round(e.maxFileBytes/1048576);throw new Error(`音频文件过大（最大 ${o}MB）`)}const r=await this.getAudioDuration(t);if(!Number.isFinite(r)||r<=0)throw new Error("无法读取音频时长");if(r>e.maxDurationSeconds){const o=Math.round(e.maxDurationSeconds/60);throw new Error(`音频时长过长（最大 ${o} 分钟）`)}}setStatus(t){const e=document.getElementById("status");e&&(e.textContent=t)}}new q;
