import{c as v,r as F}from"./math-BLsufJHS.js";const S={audioUpload:{maxFileBytes:30*1024*1024,maxDurationSeconds:600,allowedMimeTypes:["audio/mpeg","audio/mp3","audio/wav","audio/x-wav","audio/ogg"],allowedExtensions:["mp3","wav","ogg"]},demo:{thresholdBase:.98,thresholdMid:.95,thresholdLate:.85,midPhaseStart:300,latePhaseStart:900,resetAfter:1300,latePhaseWillowChance:.5},audioAnalyzer:{analysisFps:60,climaxRmsThreshold:.3,climaxFramesThreshold:60,bass:{threshold:.4,thresholdClimax:.3,cooldown:.35,cooldownClimax:.2,launchRatioMin:.15,launchRatioMax:.3},mid:{threshold:.15,cooldown:.15,launchRatioMin:.4,launchRatioMax:.6},piano:{quietMin:.05,quietMax:.15,cooldown:.8,energyScale:.8,launchRatioMin:.3,launchRatioMax:.7},waveformSamples:1e3,progressStep:100},beatDetector:{fps:60,onsetWindowSeconds:.1,onsetThreshold:.15,onsetMinEnergy:.1,onsetMinDistance:.15,tempo:{fallbackBpm:120,minInterval:.3,maxInterval:1,histogramBin:.02,normalizeMinBpm:80,normalizeMaxBpm:160,confidenceDivisor:.5},beatGrid:{offsetStep:.01,alignmentTolerance:.05}},sectionDetector:{windowSize:4,minSectionDuration:8,trendThreshold:.1,highThresholdFactor:.5,lowThresholdFactor:.5,climaxCountThreshold:2,climaxEnergyFactor:.95,chorusEnergyFactor:.7,chorusEventCount:5,prechorusEnergyFactor:.8,lowEventCount:2,introPosition:.15,outroPosition:.85,defaultEnergy:.5,transitionThreshold:.5},ruleEngine:{finale:{cooldown:10,remainingSeconds:10,minEnergy:.6,targetY:.2},climaxSalvo:{cooldown:2,targetY:.2,countBase:15,countEnergyScale:10,intervalMs:40},beatDrop:{cooldown:4,nearBeatTolerance:.1,recentEnergyWindow:3,recentEnergyThreshold:.3,minEnergy:.6,targetY:.2,count:5},sectionTransition:{cooldown:8,nearStartWindow:.5,targetY:.25},chorusSymmetric:{cooldown:1.5,minEnergy:.5,spread:.25},pianoBeatSync:{cooldown:.3,beatTolerance:.05,minEnergy:.5,energyScale:.9,hue:45},bassImpact:{cooldown:.35,minEnergy:.4},midAccent:{cooldown:.2,minEnergy:.3,energyScale:.8},ambientScatter:{cooldown:3,maxEnergy:.3,targetY:.4,count:3,energy:.45}},choreographer:{recentEventsWindow:2,lookAheadSeconds:.5,launchTrackingWindow:3,sparseThreshold:3,minEnergyFloor:.55,sparseBoostPerMissing:.15,energyCap:1,defaultTrigger:{targetYFactor:.25,energy:.6}},timeline:{climaxCooldown:2,initialSalvoTime:-10,climaxWillowRoll:.6}};class A{screenHeight;constructor(e){this.screenHeight=e}resize(e){this.screenHeight=e}async analyze(e,o){const t=S.audioAnalyzer,n=e.getChannelData(0),i=e.sampleRate,s=Math.floor(i/t.analysisFps),r=[];let a=0,l=0,p=0;const h=Math.ceil(n.length/s);let c=0;for(let d=0;d<n.length;d+=s){let x=0;for(let M=0;M<s&&d+M<n.length;M++)x+=n[d+M]*n[d+M];const u=Math.sqrt(x/s),m=d/i;u>t.climaxRmsThreshold?a++:a=Math.max(0,a-1);const T=a>t.climaxFramesThreshold,b=T?t.bass.thresholdClimax:t.bass.threshold,B=T?t.bass.cooldownClimax:t.bass.cooldown,z=t.mid.threshold,R=u<t.piano.quietMax&&u>t.piano.quietMin;if(u>b&&m-l>B){const M=v(this.screenHeight,F(t.bass.launchRatioMin,t.bass.launchRatioMax));r.push({launchTime:m-M.duration,explodeTime:m,type:"bass",isClimax:T,targetY:M.targetY,energy:u}),l=m}else if(u>z&&m-p>t.mid.cooldown){const M=v(this.screenHeight,F(t.mid.launchRatioMin,t.mid.launchRatioMax));r.push({launchTime:m-M.duration,explodeTime:m,type:"mid",isClimax:T,targetY:M.targetY,energy:u}),p=m}else if(R&&m-p>t.piano.cooldown){const M=v(this.screenHeight,F(t.piano.launchRatioMin,t.piano.launchRatioMax));r.push({launchTime:m-M.duration,explodeTime:m,type:"piano",isClimax:!1,targetY:M.targetY,energy:u*t.piano.energyScale}),p=m}c++,c%t.progressStep===0&&o?.onProgress&&o.onProgress(c/h)}r.sort((d,x)=>d.launchTime-x.launchTime);const f=t.waveformSamples,g=Math.floor(n.length/f),y=new Float32Array(f);for(let d=0;d<f;d++){let x=0;const u=d*g;for(let m=0;m<g&&u+m<n.length;m++)x=Math.max(x,Math.abs(n[u+m]));y[d]=x}const w={timeline:r,duration:e.duration,waveform:y,sampleRate:i};return o?.onComplete?.(w),w}static exportJSON(e){return JSON.stringify({duration:e.duration,sampleRate:e.sampleRate,eventCount:e.timeline.length,events:e.timeline.map(o=>({type:o.type,time:o.explodeTime.toFixed(3),energy:o.energy.toFixed(3),isClimax:o.isClimax}))},null,2)}}class D{fftSize;fps;constructor(e=2048,o=30){this.fftSize=e,this.fps=o}async analyze(e,o){const t=e.sampleRate,n=e.getChannelData(0),i=e.duration,s=Math.floor(t/this.fps),r=Math.ceil(n.length/s),a=new Float32Array(r),l=new Float32Array(r),p=new Float32Array(r),h=[],c=t/this.fftSize,f=Math.floor(200/c),g=Math.floor(2e3/c),y=Math.floor(8e3/c),w=100;for(let d=0;d<r;d+=w){const x=Math.min(d+w,r);for(let u=d;u<x;u++){const m=u*s,T=this.computeFFT(n,m,t),b=this.downsampleSpectrum(T,128);h.push(b),a[u]=this.calculateBandEnergy(T,0,f),l[u]=this.calculateBandEnergy(T,f,g),p[u]=this.calculateBandEnergy(T,g,y)}o?.onProgress&&o.onProgress(x/r),await this.yieldToUI()}return this.normalizeArray(a),this.normalizeArray(l),this.normalizeArray(p),{bass:a,mid:l,high:p,spectrogram:h,frequencyBinCount:128,sampleRate:t,duration:i,fps:this.fps}}computeFFT(e,o,t){const n=this.fftSize,i=new Float32Array(n/2),s=new Float32Array(n),r=new Float32Array(n);for(let a=0;a<n&&o+a<e.length;a++){const l=.5*(1-Math.cos(2*Math.PI*a/(n-1)));s[a]=(e[o+a]??0)*l}this.fft(s,r);for(let a=0;a<n/2;a++)i[a]=Math.sqrt(s[a]*s[a]+r[a]*r[a])/n;return i}fft(e,o){const t=e.length,n=Math.log2(t);if(Math.pow(2,n)!==t)throw new Error("FFT size must be a power of 2");for(let i=0;i<t;i++){const s=this.reverseBits(i,n);if(s>i){const r=e[i];e[i]=e[s],e[s]=r;const a=o[i];o[i]=o[s],o[s]=a}}for(let i=2;i<=t;i*=2){const s=i/2,r=-2*Math.PI/i;for(let a=0;a<t;a+=i)for(let l=0;l<s;l++){const p=r*l,h=Math.cos(p),c=Math.sin(p),f=a+l,g=a+l+s,y=h*e[g]-c*o[g],w=c*e[g]+h*o[g];e[g]=e[f]-y,o[g]=o[f]-w,e[f]=e[f]+y,o[f]=o[f]+w}}}reverseBits(e,o){let t=0;for(let n=0;n<o;n++)t=t<<1|e&1,e>>=1;return t}downsampleSpectrum(e,o){const t=new Float32Array(o),n=e.length/o;for(let i=0;i<o;i++){const s=Math.floor(i*n),r=Math.floor((i+1)*n);let a=0;for(let l=s;l<r;l++)a+=e[l];t[i]=a/(r-s)}return t}calculateBandEnergy(e,o,t){let n=0;const i=Math.min(t,e.length)-o;for(let s=o;s<Math.min(t,e.length);s++)n+=e[s]*e[s];return i>0?Math.sqrt(n/i):0}normalizeArray(e){let o=0;for(let t=0;t<e.length;t++)e[t]>o&&(o=e[t]);if(o>0)for(let t=0;t<e.length;t++)e[t]=e[t]/o}yieldToUI(){return new Promise(e=>setTimeout(e,0))}static binToFrequency(e,o,t){return e*o/t}static frequencyToBin(e,o,t){return Math.round(e*t/o)}}class P{fps;constructor(e=S.beatDetector.fps){this.fps=e}detectBeats(e,o){const t=this.detectOnsets(e),{bpm:n,confidence:i}=this.estimateTempo(t,o),s=60/n,r=this.generateBeatGrid(t,s,o);return{bpm:n,beats:r,confidence:i,beatInterval:s}}detectOnsets(e){const o=[],t=S.beatDetector,n=Math.floor(this.fps*t.onsetWindowSeconds),i=t.onsetThreshold;for(let s=n;s<e.length-n;s++){let r=0;for(let y=s-n;y<s+n;y++)r+=e[y];const a=r/(n*2),l=e[s],p=e[s-1],h=e[s+1],c=l>p&&l>h,f=l>a+i,g=l>t.onsetMinEnergy;if(c&&f&&g){const y=s/this.fps,w=o[o.length-1];(!w||y-w>t.onsetMinDistance)&&o.push(y)}}return o}estimateTempo(e,o){const t=S.beatDetector.tempo;if(e.length<4)return{bpm:t.fallbackBpm,confidence:0};const n=[];for(let h=1;h<e.length;h++){const c=e[h]-e[h-1];c>t.minInterval&&c<t.maxInterval&&n.push(c)}if(n.length<2)return{bpm:t.fallbackBpm,confidence:0};const i=new Map,s=t.histogramBin;for(const h of n){const c=Math.round(h/s)*s;i.set(c,(i.get(c)||0)+1)}let r=0,a=.5;for(const[h,c]of i)c>r&&(r=c,a=h);let l=60/a;for(;l<t.normalizeMinBpm;)l*=2;for(;l>t.normalizeMaxBpm;)l/=2;const p=Math.min(1,r/(n.length*t.confidenceDivisor));return{bpm:Math.round(l),confidence:p}}generateBeatGrid(e,o,t){const n=S.beatDetector.beatGrid,i=[];let s=0,r=0;for(let a=0;a<o;a+=n.offsetStep){let l=0;for(const p of e){const h=(p-a)%o;Math.min(h,o-h)<n.alignmentTolerance&&l++}l>r&&(r=l,s=a)}for(let a=s;a<t;a+=o)i.push(a);return i}static getBeatNumber(e,o,t=0){return Math.floor((e-t)/o)%4+1}static isOnBeat(e,o,t=.05){for(const n of o)if(Math.abs(e-n)<t)return!0;return!1}}export{A,P as B,D as F,S as T};
